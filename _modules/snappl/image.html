<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>snappl.image &#8212; roman_snpit_snappl 0.1.dev1+g70ce0fe7e documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=5a6b8c39" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=f3bc516d" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <script src="../../_static/documentation_options.js?v=bf194bd7"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo_black_filled.png" alt="Logo" />
    
  </a>
</p>



<p class="blurb">Software developed by the Roman SNPIT</p>






<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">snappl API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../database_schema.html">Database Schema</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <h1>Source code for snappl.image</h1><div class="highlight"><pre>
<span></span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Image&#39;</span><span class="p">,</span> <span class="s1">&#39;Numpy2DImage&#39;</span><span class="p">,</span> <span class="s1">&#39;FITSImage&#39;</span><span class="p">,</span> <span class="s1">&#39;FITSImageStdHeaders&#39;</span><span class="p">,</span> <span class="s1">&#39;FITSImageOnDisk&#39;</span><span class="p">,</span>
            <span class="s1">&#39;OpenUniverse2024FITSImage&#39;</span><span class="p">,</span> <span class="s1">&#39;RomanDatamodelImage&#39;</span> <span class="p">]</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fitsio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.nddata.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cutout2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">skycoord_to_pixel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.modeling.fitting</span><span class="w"> </span><span class="kn">import</span> <span class="n">NonFiniteValueError</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.aperture</span><span class="w"> </span><span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">aperture_photometry</span><span class="p">,</span> <span class="n">ApertureStats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PSFPhotometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">photutils.background</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalBackground</span><span class="p">,</span> <span class="n">MMMBackground</span><span class="p">,</span> <span class="n">Background2D</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">galsim.roman</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">roman_datamodels</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">SNLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.wcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">AstropyWCS</span><span class="p">,</span> <span class="n">GalsimWCS</span><span class="p">,</span> <span class="n">GWCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">asUUID</span>


<span class="c1"># ======================================================================</span>
<span class="c1"># The base class for all images.  This is not useful by itself, you need</span>
<span class="c1">#   to instantiate a subclass.  However, everything that you call on an</span>
<span class="c1">#   object you instantiate should have its interface defined in this</span>
<span class="c1">#   class.</span>

<div class="viewcode-block" id="Image">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Image</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encapsulates a single 2d image.</span>

<span class="sd">    Properties inclue the following.  Some of these properties may not</span>
<span class="sd">    be defined for some subclasses of Image.</span>

<span class="sd">    * path : pathlib.Path; absolute path to the image on disk</span>
<span class="sd">    * pointing : int (str?); a unique identifier of the exposure associated with the image</span>
<span class="sd">    * sca : int (str?); the SCA of this image</span>
<span class="sd">    * band : str; filter</span>
<span class="sd">    * mjd : float; mjd of the start of the image</span>
<span class="sd">    * position_angle : float; position anglke in degree east of north (yes?) (is this defined?)</span>
<span class="sd">    * exptime : float; exposure time in seconds</span>
<span class="sd">    * sky_level : float; an estimate of the sky level in ADU if defined, which it often isn&#39;t</span>
<span class="sd">    * zeropoint : float; convert to AB mag with -2.5*log(adu) + zeropoint, where adu is the units of data</span>

<span class="sd">    * image_shape : tuple (ny, nx) of ints; the image size</span>
<span class="sd">    * data : 2d numpy array; the data of this image</span>
<span class="sd">    * noise : 2d numpy array; a 1Ïƒ noise image (if defined)</span>
<span class="sd">    * flags : 2d numpy array of ints; a pixel flags image (if defined)</span>
<span class="sd">    * coord_center : SOMETHING; ra and dec at the center of the image.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data_array_list</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span> <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pointing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">provenance_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiate an image.  You probably don&#39;t want to do that.</span>

<span class="sd">        This is an abstract base class that has limited functionality.</span>
<span class="sd">        You probably want to instantiate a subclass.</span>

<span class="sd">        For all implementations, the properties data, noise, and flags</span>
<span class="sd">        are lazy-loaded.  That is, they start empty, but when you access</span>
<span class="sd">        them, an internal buffer gets loaded with that data.  This means</span>
<span class="sd">        it can be very easy for lots of memory to get used without your</span>
<span class="sd">        realizing it.  There are a couple of solutions.  The first, is</span>
<span class="sd">        to call Image.free() when you&#39;re sure you don&#39;t need the data</span>
<span class="sd">        any more, or if you know you want to get rid of it for a while</span>
<span class="sd">        and re-read it from disk later.  The second is just not to</span>
<span class="sd">        access the data, noise, and flags properties, instead use</span>
<span class="sd">        Image.get_data(), and manage the data object lifetime yourself.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          path : str</span>
<span class="sd">            Path to image file, or otherwise some kind of indentifier</span>
<span class="sd">            that allows the object to find the image.  Exactly what</span>
<span class="sd">            this needs to be is subclass-dependent, but it is usually</span>
<span class="sd">            a full absolute path on disk.</span>

<span class="sd">            If you don&#39;t know the path, but only know (say) the</span>
<span class="sd">            pointing, band, and sca of an image, then either use the</span>
<span class="sd">            get_image() method of an appropriate ImageCollection instead</span>
<span class="sd">            of instantiating an Image directly, or use the</span>
<span class="sd">            get_image_path() method of an appropriate ImageCollection.</span>

<span class="sd">          pointing : int (str?), default None</span>
<span class="sd">            The exposure this image is associated with.  If None, then</span>
<span class="sd">            the image will try to figure out the pointing from the path,</span>
<span class="sd">            if the specific Image subclass is able to do that.</span>

<span class="sd">          sca : int, default None</span>
<span class="sd">            The Sensor Chip Assembly that would be called the</span>
<span class="sd">            chip number for any other telescope but is called SCA for</span>
<span class="sd">            Roman.</span>

<span class="sd">          id : UUID or str that can be converted to UUID, default None</span>
<span class="sd">            Database ID of the image.  This is only relevant if the</span>
<span class="sd">            image is in the l2image table of the Roman SNPIT internal</span>
<span class="sd">            database (but is required in that case).</span>

<span class="sd">          provenance_id : UUID or str that can be converted to UUID, default NOne</span>
<span class="sd">            The id of the provenance of the image.  Only relevant if the</span>
<span class="sd">            image is in the l2image table of the Roman SNPIT internal</span>
<span class="sd">            database (but is required in that case).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">path</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pointing</span> <span class="o">=</span> <span class="n">pointing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sca</span> <span class="o">=</span> <span class="n">sca</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mjd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># a BaseWCS object (in wcs.py)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_cutout</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zeropoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">asUUID</span><span class="p">(</span> <span class="nb">id</span> <span class="p">)</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provenance_id</span> <span class="o">=</span> <span class="n">asUUID</span><span class="p">(</span> <span class="n">provenance_id</span> <span class="p">)</span> <span class="k">if</span> <span class="n">provenance_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The database image uuid in the l2image table.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="nd">@id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;USE THIS WITH CARE.  It doesn&#39;t change the database, only the object in memory.  You may become confused.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">asUUID</span><span class="p">(</span> <span class="n">new_value</span> <span class="p">)</span> <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">provenance_id</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The database provenance uuid of the image in the l2image table.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provenance_id</span>

    <span class="nd">@provenance_id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">provenance_id</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;USE THIS WITH CARE.  It doesn&#39;t change the database, only the object in memory.  You may become confused.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provenance_id</span> <span class="o">=</span> <span class="n">asUUID</span><span class="p">(</span> <span class="n">new_value</span> <span class="p">)</span> <span class="k">if</span> <span class="n">new_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The image data, a 2d numpy array.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement data&quot;</span> <span class="p">)</span>

    <span class="nd">@data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement data setter&quot;</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">noise</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The 1Ïƒ pixel noise, a 2d numpy array.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement noise&quot;</span> <span class="p">)</span>

    <span class="nd">@noise</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">noise</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement noise setter&quot;</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flags</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An integer 2d numpy array of pixel masks / flags TBD</span>

<span class="sd">        TODO : think about what we mean by this.  Right now it&#39;s subclass-dependent.  But, for</span>
<span class="sd">        usage, we need a way of making this more general. Issue #45.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement flags&quot;</span> <span class="p">)</span>

    <span class="nd">@flags</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flags</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement flags setter&quot;</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">image_shape</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tuple: (ny, nx) pixel size of image.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement image_shape&quot;</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sca</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sca</span>

    <span class="nd">@sca</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sca</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sca</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pointing</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pointing</span>

    <span class="nd">@pointing</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pointing</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pointing</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sky_level</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Estimate of the sky level in ADU.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;Do.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">exptime</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exposure time in seconds.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement exptime&quot;</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">band</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Band (str)&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement band&quot;</span> <span class="p">)</span>

    <span class="nd">@band</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">band</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{self.__class__.__name__}</span><span class="s2"> needs to implement band setter&quot;</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">zeropoint</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Image zeropoint for AB magnitudes.</span>

<span class="sd">        The zeropoint zp is defined so that an object with total counts</span>
<span class="sd">        c (in whatever units data is in) has AB magnitude m:</span>

<span class="sd">           m = -2.5 * log(10) + zp</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zeropoint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zeropoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_zeropoint</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zeropoint</span>

    <span class="nd">@zeropoint</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">zeropoint</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zeropoint</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mjd</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;MJD of the start of the image (defined how? TAI?)&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement mjd&quot;</span> <span class="p">)</span>

    <span class="nd">@mjd</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mjd</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="c1"># We need an MJD setter so that ImageCollection can set the MJD when fetching the images, much faster than</span>
        <span class="c1"># reading the header each time!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mjd</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">position_angle</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Position angle in degrees east of north (or what)?&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement position_angle&quot;</span> <span class="p">)</span>

<div class="viewcode-block" id="Image.fraction_masked">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.fraction_masked">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fraction_masked</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fraction of pixels that are masked.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;Do.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Image.get_data">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.get_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">always_reload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the data from disk and return one or more 2d numpy arrays of data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          which : str</span>
<span class="sd">            What to read:</span>
<span class="sd">              &#39;data&#39; : just the image data</span>
<span class="sd">              &#39;noise&#39; : just the noise data</span>
<span class="sd">              &#39;flags&#39; : just the flags data</span>
<span class="sd">              &#39;all&#39; : data, noise, and flags</span>

<span class="sd">          always_reload: bool, default False</span>
<span class="sd">            Whether this is supported depends on the subclass.  If this</span>
<span class="sd">            is false, then get_data() has the option of returning the</span>
<span class="sd">            values of self.data, self.noise, and/or self.flags instead</span>
<span class="sd">            of always loading the data.  If this is True, then</span>
<span class="sd">            get_data() will ignore the self._data et al. properties.</span>

<span class="sd">          cache: bool, default False</span>
<span class="sd">            Normally, get_data() just reads the data and does not do any</span>
<span class="sd">            internal caching.  If this is True, and the subclass</span>
<span class="sd">            supports it, then the object will cache the loaded data so</span>
<span class="sd">            that future calls with always_reload will not need to reread</span>
<span class="sd">            the data, nor will accessing the data, noise, and flags</span>
<span class="sd">            properties.</span>

<span class="sd">        The data read not stored in the class, so when the caller goes</span>
<span class="sd">        out of scope, the data will be freed (unless the caller saved it</span>
<span class="sd">        somewhere.  This does mean it&#39;s read from disk every time.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          list (length 1 or 3 ) of 2d numpy arrays</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement get_data&quot;</span> <span class="p">)</span></div>



<div class="viewcode-block" id="Image.free">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.free">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">free</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to free memory.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement free&quot;</span> <span class="p">)</span></div>


<div class="viewcode-block" id="Image.get_wcs">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.get_wcs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_wcs</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">wcsclass</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get image WCS.  Will be an object of type BaseWCS (from wcs.py) (really likely a subclass).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          wcsclass : str or None</span>
<span class="sd">            By default, the subclass of BaseWCS you get back will be</span>
<span class="sd">            defined by the Image subclass of the object you call this</span>
<span class="sd">            on.  If you want a specific subclass of BaseWCS, you can put</span>
<span class="sd">            the name of that class here.  It may not always work; not</span>
<span class="sd">            all types of images are able to return all types of wcses.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          object of a subclass of snappl.wcs.BaseWCS</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement get_wcs&quot;</span> <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_zeropoint</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the zeropoint; see &quot;zeropoint&quot; property above.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement _get_zeropoint&quot;</span> <span class="p">)</span>

<div class="viewcode-block" id="Image.get_ra_dec_cutout">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.get_ra_dec_cutout">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ra_dec_cutout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a new snappl image object that is a cutout of the original image, at a location in pixel-space.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ra : float</span>
<span class="sd">            RA coordinate of the center of the cutout, in degrees.</span>
<span class="sd">        dec : float</span>
<span class="sd">            DEC coordinate of the center of the cutout, in degrees.</span>
<span class="sd">        xsize : int</span>
<span class="sd">            Width of the cutout in pixels.</span>
<span class="sd">        ysize : int</span>
<span class="sd">            Height of the cutout in pixels. If None, set to xsize.</span>
<span class="sd">        mode : str, default &#39;strict&#39;</span>
<span class="sd">            &quot;strict&quot; does not allow for partial overlap between the cutout and the original image,</span>
<span class="sd">            &quot;partial&quot; will fill in non-overlapping pixels with fill_value. This is identical to the</span>
<span class="sd">            mode parameter of astropy.nddata.Cutout2D.</span>
<span class="sd">        fill_value : float, default np.nan</span>
<span class="sd">            Fill value for pixels that are outside the original</span>
<span class="sd">            image when mode=&#39;partial&#39;. This is identical to the fill_value parameter</span>
<span class="sd">            of astropy.nddata.Cutout2D.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cutout : snappl.image.Image</span>
<span class="sd">            A new snappl image object that is a cutout of the original image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement get_ra_dec_cutout&quot;</span> <span class="p">)</span></div>


<div class="viewcode-block" id="Image.get_cutout">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.get_cutout">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cutout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a cutout of the image at the given RA and DEC.</span>
<span class="sd">        This implementation assumes that the image WCS is an AstropyWCS.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : int</span>
<span class="sd">            x pixel coordinate of the center of the cutout.</span>
<span class="sd">        y : int</span>
<span class="sd">            y pixel coordinate of the center of the cutout.</span>
<span class="sd">        xsize : int</span>
<span class="sd">            Width of the cutout in pixels.</span>
<span class="sd">        ysize : int</span>
<span class="sd">            Height of the cutout in pixels. If None, set to xsize.</span>
<span class="sd">        mode : str, default &#39;strict&#39;</span>
<span class="sd">            &quot;strict&quot; does not allow for partial overlap between the cutout and the original image,</span>
<span class="sd">            &quot;partial&quot; will fill in non-overlapping pixels with fill_value. This is identical to the</span>
<span class="sd">            mode parameter of astropy.nddata.Cutout2D.</span>
<span class="sd">        fill_value : float, default np.nan</span>
<span class="sd">            Fill value for pixels that are outside the original</span>
<span class="sd">            image when mode=&#39;partial&#39;. This is identical to the fill_value parameter</span>
<span class="sd">            of astropy.nddata.Cutout2D.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cutout : snappl.image.Image</span>
<span class="sd">            A new snappl image object that is a cutout of the original image.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement get_cutout&quot;</span> <span class="p">)</span></div>



    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coord_center</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;[RA, DEC] (both floats) in degrees at the center of the image&quot;&quot;&quot;</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">wcs</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span><span class="mi">2</span> <span class="p">)</span>


<div class="viewcode-block" id="Image.includes_radec">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.includes_radec">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">includes_radec</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="p">):</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span> <span class="n">ra</span><span class="o">=</span><span class="n">ra</span> <span class="o">*</span> <span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span> <span class="o">*</span> <span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">deg</span> <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span> <span class="n">sc</span><span class="p">,</span> <span class="n">wcs</span><span class="o">.</span><span class="n">get_astropy_wcs</span><span class="p">()</span> <span class="p">)</span>
        <span class="k">except</span> <span class="n">astropy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">NoConvergence</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># NOTE : we&#39;re assuming a full-size image here.  Think about cutouts!</span>
        <span class="k">return</span> <span class="p">(</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">4088</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">4088</span> <span class="p">)</span></div>



<div class="viewcode-block" id="Image.ap_phot">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.ap_phot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ap_phot</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;subpixel&#39;</span><span class="p">,</span> <span class="n">subpixels</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">bgsize</span><span class="o">=</span><span class="mi">511</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do aperture photometry on the image at the specified coordinates.</span>

<span class="sd">        Does background subtraction using</span>
<span class="sd">        photutils.background.Background2D with box size bgsize.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          coords: astropy.table.Table</span>
<span class="sd">            Must have (at least) columns &#39;x&#39; and &#39;y&#39; representing</span>
<span class="sd">            0-origin pixel coordinates. (CHECK THIS)</span>

<span class="sd">          ap_r: float, default 9</span>
<span class="sd">            Aperture radius in pixels</span>

<span class="sd">          method: str, default &#39;subpixel&#39;</span>
<span class="sd">            Passed to the &quot;method&quot; parmeter of photutils.photometry.aperture_photometry</span>

<span class="sd">          subpixels: int, default 5</span>
<span class="sd">            Number of subpixels to use for the &#39;subpixel&#39; method.</span>

<span class="sd">          bgsize: int, default 511</span>
<span class="sd">            Box size for photutils Background2D background subtraction.</span>
<span class="sd">            Set to &lt;=0 to not do background subtraction.</span>

<span class="sd">          **kwargs : further arguments are passed directly to photutils.photometry.aperture_photometry</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          results: astropy.table.Table</span>
<span class="sd">            Results of photutils.aperture.aperture_photometry</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="n">photcoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]))</span>
        <span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">photcoords</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">ap_r</span><span class="p">)</span>

        <span class="c1"># This is potentially slow; thing about caching background if we&#39;re ever going to use ap_phot for real,</span>
        <span class="c1">#   especially if it&#39;s going to be called repeatedly on the same image.</span>
        <span class="n">bg</span> <span class="o">=</span> <span class="mf">0.</span> <span class="k">if</span> <span class="n">bgsize</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Background2D</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="n">bgsize</span> <span class="p">)</span><span class="o">.</span><span class="n">background</span>

        <span class="n">ap_results</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">bg</span><span class="p">,</span>
                                          <span class="n">apertures</span><span class="p">,</span>
                                          <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                          <span class="n">subpixels</span><span class="o">=</span><span class="n">subpixels</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
        <span class="n">apstats</span> <span class="o">=</span> <span class="n">ApertureStats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">apertures</span><span class="p">)</span>
        <span class="n">ap_results</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apstats</span><span class="o">.</span><span class="n">max</span>

        <span class="k">return</span> <span class="n">ap_results</span></div>



<div class="viewcode-block" id="Image.psf_phot">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.psf_phot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">psf_phot</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">init_params</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">forced_phot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fit_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                  <span class="n">bginner</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">bgouter</span><span class="o">=</span><span class="mi">25</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do psf photometry.</span>

<span class="sd">        Does local background subtraction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          init_params: something</span>
<span class="sd">             passed to the init_params of a call to a</span>
<span class="sd">             photutils.psf.PSFPHotometry object.</span>

<span class="sd">          psf: snappl.psf.PSF</span>
<span class="sd">             The PSF profile to fit to the image.</span>

<span class="sd">          forced_phot: bool, default True</span>
<span class="sd">             If True, then the x and y positions are fixed.  If False,</span>
<span class="sd">             then they will be fit along with the flux.</span>

<span class="sd">          fit_shape: tuple of (int, int), default (5, 5)</span>
<span class="sd">             Shape of the stamp around the positions in which to do the fit.</span>

<span class="sd">          bginner: float, default 15</span>
<span class="sd">             Radius of inner boundry of annulus in which to measure background.</span>

<span class="sd">          bouter: float, default 25</span>
<span class="sd">             Radius of outer boundry of annulus in which to measure background.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          TODO</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;flux_init&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">init_params</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Astropy table passed to kwarg init_params must contain column </span><span class="se">\&quot;</span><span class="s1">flux_init</span><span class="se">\&quot;</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="n">psfmod</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">getImagePSF</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">forced_phot</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s1">&#39;psf_phot: x, y are fixed!&#39;</span> <span class="p">)</span>
            <span class="n">psfmod</span><span class="o">.</span><span class="n">x_0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">psfmod</span><span class="o">.</span><span class="n">y_0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s1">&#39;psf_phot: x, y are fitting parameters!&#39;</span> <span class="p">)</span>
            <span class="n">psfmod</span><span class="o">.</span><span class="n">x_0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">psfmod</span><span class="o">.</span><span class="n">x_0</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bkgfunc</span> <span class="o">=</span> <span class="n">LocalBackground</span><span class="p">(</span><span class="n">bginner</span><span class="p">,</span> <span class="n">bgouter</span><span class="p">,</span> <span class="n">MMMBackground</span><span class="p">())</span>
            <span class="n">psfphot</span> <span class="o">=</span> <span class="n">PSFPhotometry</span><span class="p">(</span><span class="n">psfmod</span><span class="p">,</span> <span class="n">fit_shape</span><span class="p">,</span> <span class="n">localbkg_estimator</span><span class="o">=</span><span class="n">bkgfunc</span><span class="p">)</span>
            <span class="n">psf_results</span> <span class="o">=</span> <span class="n">psfphot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span> <span class="n">init_params</span><span class="o">=</span><span class="n">init_params</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">psf_results</span>

        <span class="k">except</span> <span class="n">NonFiniteValueError</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span> <span class="s1">&#39;fit_shape overlaps with edge of image, and therefore encloses NaNs! &#39;</span>
                                <span class="s1">&#39;Photometry cancelled.&#39;</span> <span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="Image.save_data">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.save_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_data</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noisepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flagspath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Same as save; here for backwards compatibility.  Use save.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span> <span class="n">which</span><span class="o">=</span><span class="n">which</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">noisepath</span><span class="o">=</span><span class="n">noisepath</span><span class="p">,</span> <span class="n">flagspath</span><span class="o">=</span><span class="n">flagspath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span> <span class="p">)</span></div>



<div class="viewcode-block" id="Image.save">
<a class="viewcode-back" href="../../api/snappl.image.Image.html#snappl.image.Image.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noisepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flagspath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the image to its path(s).</span>

<span class="sd">        May have side-effects on the internal data structure (e.g. FITS</span>
<span class="sd">        subclasses modify the internally stored header).</span>

<span class="sd">        Paramters</span>
<span class="sd">        ---------</span>
<span class="sd">          which : str, default &quot;all&quot;</span>
<span class="sd">            One of &#39;data&#39;, &#39;noise&#39;, &#39;flags&#39;, or &#39;all&#39;</span>

<span class="sd">          path : str, default None</span>
<span class="sd">            Path to write the image to.  If not specified, will use use</span>
<span class="sd">            self.path.  Does NOT update self.path.</span>

<span class="sd">          noisepath : str, default None</span>
<span class="sd">            Path to write the noise image to, if the noise image is</span>
<span class="sd">            stored as a separate image.  (It isn&#39;t always; some</span>
<span class="sd">            subclasses have it as a separate part of the data structure</span>
<span class="sd">            that also has the image.)  If None, use an internally stored</span>
<span class="sd">            noisepath.  If that is not set, and noisepath is None, and</span>
<span class="sd">            this isn&#39;t a subclass that combines all the data planes into</span>
<span class="sd">            one file, then any noise data array will not be written.</span>

<span class="sd">          flagspath : str, defanot None</span>
<span class="sd">            Path to write the flags image to, similar to noisepath.</span>

<span class="sd">          overwrite : bool, default False</span>
<span class="sd">            Clobber existing images?</span>

<span class="sd">        Not implemented for all subclasses.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__name</span><span class="si">}</span><span class="s2"> doesn&#39;t implement save&quot;</span> <span class="p">)</span></div>
</div>




<span class="c1"># ======================================================================</span>
<span class="c1"># Lots of classes will probably internally store all of data, noise, and</span>
<span class="c1">#   flags as 2d numpy arrays.  Common code for those classes is here.</span>

<div class="viewcode-block" id="Numpy2DImage">
<a class="viewcode-back" href="../../api/snappl.image.Numpy2DImage.html#snappl.image.Numpy2DImage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Numpy2DImage</span><span class="p">(</span> <span class="n">Image</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract class for classes that store their array internall as a numpy 2d array.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noise</span> <span class="o">=</span> <span class="n">noise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="o">=</span> <span class="n">flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image_shape</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">(</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;data&#39;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="nd">@data</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
             <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">new_value</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span>
             <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span><span class="mi">2</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">new_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="s2">&quot;Data must be a 2d numpy array of floats.&quot;</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">noise</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">(</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;noise&#39;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise</span>

    <span class="nd">@noise</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">noise</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span> <span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">new_value</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">new_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_noise</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="s2">&quot;Noise must be a 2d numpy array of floats.&quot;</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flags</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">(</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;flags&#39;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span>

    <span class="nd">@flags</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flags</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span> <span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">new_value</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">new_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="s2">&quot;Flags must be a 2d numpy array of integers.&quot;</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">image_shape</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subclasses probably want to override this!</span>

<span class="sd">        This implementation accesses the .data property, which will load the data</span>
<span class="sd">        from disk if it hasn&#39;t been already.  Actual images are likely to have</span>
<span class="sd">        that information availble in a manner that doesn&#39;t require loading all</span>
<span class="sd">        the image data (e.g. in a header), so subclasses should do that.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_shape</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_data</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;all&quot;</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads (or reloads) the data from disk.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="n">which</span><span class="o">=</span><span class="n">which</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">always_reload</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>

<div class="viewcode-block" id="Numpy2DImage.free">
<a class="viewcode-back" href="../../api/snappl.image.Numpy2DImage.html#snappl.image.Numpy2DImage.free">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">free</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noise</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="o">=</span> <span class="kc">None</span></div>
</div>



<span class="c1"># ======================================================================</span>
<span class="c1"># A base class for FITSImages which use an AstropyWCS wcs.  Of limited</span>
<span class="c1">#   use by itself.  Although you pass it paths, it doesn&#39;t actually</span>
<span class="c1">#   read from paths; see FITSImageOnDisk for somethign that can.</span>

<div class="viewcode-block" id="FITSImage">
<a class="viewcode-back" href="../../api/snappl.image.FITSImage.html#snappl.image.FITSImage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FITSImage</span><span class="p">(</span> <span class="n">Numpy2DImage</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for classes that read FITS images and use an AstropyWCS wcs.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">noisepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flagspath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">imagehdu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">noisehdu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">flagshdu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">std_imagenames</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span> <span class="o">=</span> <span class="n">wcs</span>

        <span class="k">if</span> <span class="n">std_imagenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span> <span class="n">imagehdu</span><span class="p">,</span> <span class="n">noisehdu</span><span class="p">,</span> <span class="n">flagshdu</span> <span class="p">)</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;std_imagenames requireds (image|noise|flags)hdu = 0&quot;</span> <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">noisepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">flagspath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;std_imagenames can&#39;t be passed with noisepath or flagspath&quot;</span> <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">imagehdu</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noisehdu</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flagshdu</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noisepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_noise.fits&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_flags.fits&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_image.fits&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noisepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">noisepath</span> <span class="p">)</span> <span class="k">if</span> <span class="n">noisepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">flagspath</span> <span class="p">)</span> <span class="k">if</span> <span class="n">flagspath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagehdu</span> <span class="o">=</span> <span class="n">imagehdu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noisehdu</span> <span class="o">=</span> <span class="n">noisehdu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flagshdu</span> <span class="o">=</span> <span class="n">flagshdu</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_fitsio_header_to_astropy_header</span><span class="p">(</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">hdr</span> <span class="p">):</span>
        <span class="c1"># I&#39;m agog that astropy.io.fits.Header can&#39;t just take a fitsio HEADER</span>
        <span class="c1">#   as a constructor argument, but there you have it.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">FITSHDR</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="s2">&quot;_fitsio_header_to_astropy_header expects a fitsio.header.FITSHDR&quot;</span> <span class="p">)</span>

        <span class="n">ahdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">records</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;comment&#39;</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">:</span>
                <span class="n">ahdr</span><span class="p">[</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ahdr</span><span class="p">[</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ahdr</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_astropy_header_to_fitsio_header</span><span class="p">(</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">ahdr</span> <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">ahdr</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">Header</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="s2">&quot;_astropy_header_to_fitsio_header expects a astrop.io.fits.header.Header&quot;</span> <span class="p">)</span>

        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">FITSHDR</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">kw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">ahdr</span> <span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">kw</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">ahdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">ahdr</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ahdr</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">add_record</span><span class="p">(</span> <span class="n">rec</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">hdr</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">image_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;tuple: (ny, nx) shape of image&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cutout</span><span class="p">:</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image_shape</span> <span class="o">=</span> <span class="p">(</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">],</span> <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_shape</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_shape</span>

<div class="viewcode-block" id="FITSImage.set_fits_header">
<a class="viewcode-back" href="../../api/snappl.image.FITSImage.html#snappl.image.FITSImage.set_fits_header">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_fits_header</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">hdr</span> <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span> <span class="p">)</span> <span class="ow">and</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="s2">&quot;FITS header must be an astropy.fits.io.header.Header&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">hdr</span></div>


    <span class="c1"># Subclasses may want to replace this with something different based on how they work</span>
<div class="viewcode-block" id="FITSImage.get_fits_header">
<a class="viewcode-back" href="../../api/snappl.image.FITSImage.html#snappl.image.FITSImage.get_fits_header">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fits_header</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the header of the image.</span>
<span class="sd">        Note that FITSImage and subclasses set self._header here, inside get_fits_header.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagehdu</span> <span class="p">]</span><span class="o">.</span><span class="n">read_header</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">FITSImage</span><span class="o">.</span><span class="n">_fitsio_header_to_astropy_header</span><span class="p">(</span> <span class="n">hdr</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span></div>



    <span class="k">def</span><span class="w"> </span><span class="nf">_strip_wcs_header_keywords</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to strip all wcs keywords from self._header.</span>

<span class="sd">        Useful as a pre-step for saving the image if you want to write</span>
<span class="sd">        the WCS to the image.  Using this makes sure (as best possible)</span>
<span class="sd">        that you don&#39;t end up with conflicting WCS keywords in the</span>
<span class="sd">        header.</span>

<span class="sd">        This may not be complete, as it pattern matches expected keywords.</span>
<span class="sd">        If it&#39;s missing some patterns, those won&#39;t get stripped.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>

        <span class="n">basematch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="sa">r</span><span class="s2">&quot;^C(RVAL|RPIX|UNIT|DELT|TYPE)[12]$&quot;</span> <span class="p">)</span>
        <span class="n">cdmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="sa">r</span><span class="s2">&quot;^CD[12]_[12]$&quot;</span> <span class="p">)</span>
        <span class="n">sipmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="sa">r</span><span class="s2">&quot;^[AB]P?_(ORDER|(\d+)_(\d+))$&quot;</span> <span class="p">)</span>
        <span class="n">tpvmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="sa">r</span><span class="s2">&quot;^P[CV]\d+_\d+$&quot;</span> <span class="p">)</span>

        <span class="n">tonuke</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">basematch</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cdmatch</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sipmatch</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tpvmatch</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span> <span class="p">):</span>
                <span class="n">tonuke</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="n">kw</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">tonuke</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span>


<div class="viewcode-block" id="FITSImage.get_wcs">
<a class="viewcode-back" href="../../api/snappl.image.FITSImage.html#snappl.image.FITSImage.get_wcs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_wcs</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">wcsclass</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="n">wcsclass</span> <span class="o">=</span> <span class="s2">&quot;AstropyWCS&quot;</span> <span class="k">if</span> <span class="n">wcsclass</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">wcsclass</span>
        <span class="k">if</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="n">wcsclass</span> <span class="p">):</span>
            <span class="k">if</span> <span class="n">wcsclass</span> <span class="o">==</span> <span class="s2">&quot;AstropyWCS&quot;</span><span class="p">:</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span> <span class="o">=</span> <span class="n">AstropyWCS</span><span class="o">.</span><span class="n">from_header</span><span class="p">(</span> <span class="n">hdr</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">wcsclass</span> <span class="o">==</span> <span class="s2">&quot;GalsimWCS&quot;</span><span class="p">:</span>
                <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span> <span class="o">=</span> <span class="n">GalsimWCS</span><span class="o">.</span><span class="n">from_header</span><span class="p">(</span> <span class="n">hdr</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span></div>


<div class="viewcode-block" id="FITSImage.get_data">
<a class="viewcode-back" href="../../api/snappl.image.FITSImage.html#snappl.image.FITSImage.get_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">always_reload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cutout</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;get_data called on a cutout image, this will return the ORIGINAL UNCUT image. Currently not supported.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">which</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Image</span><span class="o">.</span><span class="n">data_array_list</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown which </span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">, must be all, data, noise, or flags&quot;</span><span class="p">)</span>
        <span class="n">which</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span> <span class="p">]</span> <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="k">else</span> <span class="p">[</span> <span class="n">which</span> <span class="p">]</span>

        <span class="n">pathmap</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="s1">&#39;noise&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisepath</span><span class="p">,</span>
                    <span class="s1">&#39;flags&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span> <span class="p">}</span>
        <span class="n">hdumap</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagehdu</span><span class="p">,</span>
                   <span class="s1">&#39;noise&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisehdu</span><span class="p">,</span>
                   <span class="s1">&#39;flags&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagshdu</span> <span class="p">}</span>

        <span class="n">rval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">which</span><span class="p">:</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">plane</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">prop</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">always_reload</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">):</span>
                <span class="k">with</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span> <span class="n">pathmap</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span> <span class="n">hdumap</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span> <span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">data</span> <span class="p">)</span>
            <span class="n">rval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">data</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">rval</span></div>



<div class="viewcode-block" id="FITSImage.get_cutout">
<a class="viewcode-back" href="../../api/snappl.image.FITSImage.html#snappl.image.FITSImage.get_cutout">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cutout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;See Image.get_cutout</span>

<span class="sd">        The mode and fill_value parameters are passed directly to astropy.nddata.Cutout2D for FITSImage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span> <span class="p">[</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span> <span class="p">),</span>
                      <span class="nb">isinstance</span><span class="p">(</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span> <span class="p">),</span>
                      <span class="nb">isinstance</span><span class="p">(</span> <span class="n">xsize</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span> <span class="p">),</span>
                      <span class="p">(</span> <span class="n">ysize</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">ysize</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
                     <span class="p">]</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="s2">&quot;All of x, y, xsize, and ysize must be integers.&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">ysize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ysize</span> <span class="o">=</span> <span class="n">xsize</span>
        <span class="k">if</span> <span class="n">xsize</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ysize</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Size must be odd for a well defined central &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;pixel, you tried to pass a size of </span><span class="si">{</span><span class="n">xsize</span><span class="p">,</span><span class="w"> </span><span class="n">ysize</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cutting out at </span><span class="si">{</span><span class="n">x</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="s1">&#39;all&#39;</span> <span class="p">)</span>

        <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">AstropyWCS</span> <span class="p">)</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="s2">&quot;Error, FITSImage.get_cutout only works with AstropyWCS wcses&quot;</span> <span class="p">)</span>
        <span class="n">apwcs</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">wcs</span><span class="o">.</span><span class="n">_wcs</span>

        <span class="c1"># Remember that numpy arrays are indexed [y, x] (at least if they&#39;re read with astropy.io.fits)</span>

        <span class="n">astropy_cutout</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ysize</span><span class="p">,</span> <span class="n">xsize</span><span class="p">),</span> <span class="n">wcs</span><span class="o">=</span><span class="n">apwcs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>
        <span class="n">astropy_noise</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ysize</span><span class="p">,</span> <span class="n">xsize</span><span class="p">),</span> <span class="n">wcs</span><span class="o">=</span><span class="n">apwcs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>
        <span class="c1"># Because flags are integer, we can&#39;t use the same fill_value as the default.</span>
        <span class="c1"># Per the slack channel, it seemed 1 will be used for bad pixels.</span>
        <span class="c1"># https://github.com/spacetelescope/roman_datamodels/blob/main/src/roman_datamodels/dqflags.py</span>
        <span class="n">astropy_flags</span> <span class="o">=</span> <span class="n">Cutout2D</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ysize</span><span class="p">,</span> <span class="n">xsize</span><span class="p">),</span> <span class="n">wcs</span><span class="o">=</span><span class="n">apwcs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">snappl_cutout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">snappl_cutout</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">astropy_cutout</span><span class="o">.</span><span class="n">data</span>
        <span class="n">snappl_cutout</span><span class="o">.</span><span class="n">_wcs</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">AstropyWCS</span><span class="p">(</span> <span class="n">astropy_cutout</span><span class="o">.</span><span class="n">wcs</span> <span class="p">)</span>
        <span class="n">snappl_cutout</span><span class="o">.</span><span class="n">_noise</span> <span class="o">=</span> <span class="n">astropy_noise</span><span class="o">.</span><span class="n">data</span>
        <span class="n">snappl_cutout</span><span class="o">.</span><span class="n">_flags</span> <span class="o">=</span> <span class="n">astropy_flags</span><span class="o">.</span><span class="n">data</span>
        <span class="n">snappl_cutout</span><span class="o">.</span><span class="n">_is_cutout</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">snappl_cutout</span></div>


<div class="viewcode-block" id="FITSImage.get_ra_dec_cutout">
<a class="viewcode-back" href="../../api/snappl.image.FITSImage.html#snappl.image.FITSImage.get_ra_dec_cutout">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_ra_dec_cutout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;See Image.get_ra_dec_cutout</span>

<span class="sd">        The mode and fill_value parameters are passed directly to astropy.nddata.Cutout2D for FITSImage.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span> <span class="n">x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cutout</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span> <span class="p">)</span></div>


<div class="viewcode-block" id="FITSImage.save">
<a class="viewcode-back" href="../../api/snappl.image.FITSImage.html#snappl.image.FITSImage.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noisepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flagspath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">imagehdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noisehdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flagshdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write image to its path.  See Image.save</span>

<span class="sd">        Has the side-effect of loading self._header if it is None, and</span>
<span class="sd">        if replacing WCS keywords in self._header with keywords from the</span>
<span class="sd">        current image WCS.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">saveim</span> <span class="o">=</span> <span class="p">(</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="p">)</span>
        <span class="n">saveno</span> <span class="o">=</span> <span class="p">(</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;noise&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="p">)</span>
        <span class="n">savefl</span> <span class="o">=</span> <span class="p">(</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;flags&#39;</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="p">)</span>

        <span class="n">imagehdu</span> <span class="o">=</span> <span class="n">imagehdu</span> <span class="k">if</span> <span class="n">imagehdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagehdu</span>
        <span class="n">noisehdu</span> <span class="o">=</span> <span class="n">noisehdu</span> <span class="k">if</span> <span class="n">noisehdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisehdu</span>
        <span class="n">flagshdu</span> <span class="o">=</span> <span class="n">flagshdu</span> <span class="k">if</span> <span class="n">flagshdu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagshdu</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">imagehdu</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">noisehdu</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">flagshdu</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;We need to implement saving to HDUs other than 0.&quot;</span> <span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
        <span class="k">if</span> <span class="n">saveim</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;Can&#39;t save data, no path.&quot;</span> <span class="p">)</span>
        <span class="n">noisepath</span> <span class="o">=</span> <span class="n">noisepath</span> <span class="k">if</span> <span class="n">noisepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisepath</span>
        <span class="k">if</span> <span class="n">saveno</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">noisepath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;Can&#39;t save noise, no path.&quot;</span> <span class="p">)</span>
        <span class="n">flagspath</span> <span class="o">=</span> <span class="n">flagspath</span> <span class="k">if</span> <span class="n">flagspath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span>
        <span class="k">if</span> <span class="n">savefl</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">flagspath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;Can&#39;t save flags, no path.&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span>
                 <span class="p">(</span> <span class="n">noisepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">noisepath</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="p">)</span> <span class="ow">or</span>
                 <span class="p">(</span> <span class="n">flagspath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">flagspath</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="p">)</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;FITSImage.save: overwrite is False, but image file(s) already exist&quot;</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">noisepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">noisepath</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="p">):</span>
                <span class="n">noisepath</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">flagspath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">flagspath</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="p">):</span>
                <span class="n">flagspath</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># Make sure header is loaded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apwcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span><span class="o">.</span><span class="n">get_astropy_wcs</span><span class="p">(</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
            <span class="n">wcshdr</span> <span class="o">=</span> <span class="n">apwcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strip_wcs_header_keywords</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_header</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="n">wcshdr</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">wcshdr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span> <span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rw&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">FITSImage</span><span class="o">.</span><span class="n">_astropy_header_to_fitsio_header</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">noisepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">):</span>
            <span class="k">with</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span> <span class="n">noisepath</span><span class="p">,</span> <span class="s1">&#39;rw&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">FITSImage</span><span class="o">.</span><span class="n">_astropy_header_to_fitsio_header</span><span class="p">(</span> <span class="n">wcshdr</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">):</span>
            <span class="k">with</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span> <span class="n">flagspath</span><span class="p">,</span> <span class="s1">&#39;rw&#39;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">FITSImage</span><span class="o">.</span><span class="n">_astropy_header_to_fitsio_header</span><span class="p">(</span> <span class="n">wcshdr</span> <span class="p">)</span> <span class="p">)</span></div>
</div>



<span class="c1"># ======================================================================</span>
<span class="c1"># FITSImageStdHeaders</span>
<span class="c1">#</span>
<span class="c1"># A FITSImage that knows it has information in header keywords</span>
<span class="c1">#   that can be configurated at instantiation time.</span>

<div class="viewcode-block" id="FITSImageStdHeaders">
<a class="viewcode-back" href="../../api/snappl.image.FITSImageStdHeaders.html#snappl.image.FITSImageStdHeaders">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FITSImageStdHeaders</span><span class="p">(</span> <span class="n">FITSImage</span> <span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                  <span class="n">header_kws</span> <span class="o">=</span> <span class="p">{</span>
                      <span class="s1">&#39;band&#39;</span><span class="p">:</span> <span class="s2">&quot;BAND&quot;</span><span class="p">,</span>
                      <span class="s1">&#39;exptime&#39;</span><span class="p">:</span> <span class="s2">&quot;EXPTIME&quot;</span><span class="p">,</span>
                      <span class="s1">&#39;mjd&#39;</span><span class="p">:</span> <span class="s2">&quot;MJD&quot;</span><span class="p">,</span>
                      <span class="s1">&#39;pointing&#39;</span><span class="p">:</span> <span class="s2">&quot;POINTING&quot;</span><span class="p">,</span>
                      <span class="s1">&#39;sca&#39;</span><span class="p">:</span> <span class="s2">&quot;SCA&quot;</span><span class="p">,</span>
                      <span class="s1">&#39;zeropoint&#39;</span><span class="p">:</span> <span class="s2">&quot;ZPT&quot;</span> <span class="p">},</span>
                  <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span> <span class="o">=</span> <span class="n">header_kws</span>



<div class="viewcode-block" id="FITSImageStdHeaders.get_fits_header">
<a class="viewcode-back" href="../../api/snappl.image.FITSImageStdHeaders.html#snappl.image.FITSImageStdHeaders.get_fits_header">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fits_header</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">FITSImage</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">(</span> <span class="bp">self</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header</span></div>



    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pointing</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;pointing&#39;</span><span class="p">]</span> <span class="p">]</span>

    <span class="nd">@pointing</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pointing</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;pointing&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sca</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;sca&#39;</span><span class="p">]</span> <span class="p">]</span>

    <span class="nd">@sca</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sca</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;sca&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">band</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span> <span class="p">]</span>

    <span class="nd">@band</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">band</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">zeropoint</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;zeropoint&#39;</span><span class="p">]</span> <span class="p">]</span>

    <span class="nd">@zeropoint</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">zeropoint</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;zeropoint&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mjd</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">]</span> <span class="p">]</span>

    <span class="nd">@mjd</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mjd</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">exptime</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="p">]</span>

    <span class="nd">@exptime</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">exptime</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="n">hdr</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_kws</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>




<span class="c1"># ======================================================================</span>
<span class="c1"># A class that&#39;s a FITS Image with a corresponding file or</span>
<span class="c1">#  set of files on disk.</span>
<span class="c1">#</span>
<span class="c1"># If noisepath and flagspath are None, that means that all of it is</span>
<span class="c1">#   packed into different HDUs of the smage image, in path.</span>

<div class="viewcode-block" id="FITSImageOnDisk">
<a class="viewcode-back" href="../../api/snappl.image.FITSImageOnDisk.html#snappl.image.FITSImageOnDisk">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FITSImageOnDisk</span><span class="p">(</span> <span class="n">FITSImage</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An Image which is represnted by a FITS file on disk.</span>

<span class="sd">    Either there are three FITS files, one for image, one for noise, one</span>
<span class="sd">    for flags, or there is one FITS file.  If there is one FITS file,</span>
<span class="sd">    then imagehdu, noisehdu, and flagshdu must all be different.</span>

<span class="sd">    (It&#39;s also possible that there&#39;s *only* an image, which is used for</span>
<span class="sd">    some intermediate data products within pipelines.)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>


<div class="viewcode-block" id="FITSImageOnDisk.uncompressed_version">
<a class="viewcode-back" href="../../api/snappl.image.FITSImageOnDisk.html#snappl.image.FITSImageOnDisk.uncompressed_version">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">uncompressed_version</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span> <span class="p">],</span> <span class="n">base_dir</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make sure to get a FITSImageOnDisk that&#39;s not compressed.</span>

<span class="sd">        If none of the files for the current FITSImageOnDisk object are</span>
<span class="sd">        compressed, just return this object.</span>

<span class="sd">        Otherwise, will write out up to three single-HDU FITS files in</span>
<span class="sd">        base_dir (which defaults to photometry.snappl.temp_dir from the</span>
<span class="sd">        config).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          include : sequence of str</span>
<span class="sd">            Can include any of &#39;data&#39;, &#39;noise&#39;, &#39;flags&#39;; which things to</span>
<span class="sd">            write.  Ignored if the current image isn&#39;t compressed.</span>

<span class="sd">          base_dir : Path</span>
<span class="sd">            The path to write the files</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          FITSImageOnDisk</span>
<span class="sd">            The path, noisepath, and flagspath properties will be set</span>
<span class="sd">            with the random filenames to which the FITS files were written.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span> <span class="p">[</span> <span class="p">(</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.fits&#39;</span> <span class="p">)</span> <span class="p">),</span>
                  <span class="p">(</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisepath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisepath</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.fits&#39;</span> <span class="p">)</span> <span class="p">),</span>
                  <span class="p">(</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.fits&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">base_dir</span> <span class="k">if</span> <span class="n">base_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                                 <span class="k">else</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.snappl.temp_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">barf</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span> <span class="s1">&#39;0123456789abcdef&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">impath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">noisepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">flagspath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span> <span class="p">[</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">impath</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">barf</span><span class="si">}</span><span class="s2">_image.fits&quot;</span>
            <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span> <span class="n">impath</span>  <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;noise&#39;</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span> <span class="p">[</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">noisepath</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">barf</span><span class="si">}</span><span class="s2">_noise.fits&quot;</span>
            <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span> <span class="n">noisepath</span> <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;flags&#39;</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span> <span class="p">[</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">flagspath</span> <span class="o">=</span> <span class="n">base_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">barf</span><span class="si">}</span><span class="s2">_flags.fits&quot;</span>
            <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span> <span class="n">flagspath</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">FITSImageOnDisk</span><span class="p">(</span> <span class="n">path</span><span class="o">=</span><span class="n">impath</span><span class="p">,</span> <span class="n">noisepath</span><span class="o">=</span><span class="n">noisepath</span><span class="p">,</span> <span class="n">flagspath</span><span class="o">=</span><span class="n">flagspath</span> <span class="p">)</span></div>



<div class="viewcode-block" id="FITSImageOnDisk.set_header">
<a class="viewcode-back" href="../../api/snappl.image.FITSImageOnDisk.html#snappl.image.FITSImageOnDisk.set_header">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_header</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">hdr</span> <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">Header</span> <span class="p">)</span> <span class="ow">and</span> <span class="n">hdr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;hdr must be a fits.header.Header, not a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">hdr</span></div>


<div class="viewcode-block" id="FITSImageOnDisk.get_data">
<a class="viewcode-back" href="../../api/snappl.image.FITSImageOnDisk.html#snappl.image.FITSImageOnDisk.get_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">always_reload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cutout</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;get_data called on a cutout image, this will return the ORIGINAL UNCUT image. &quot;</span>
                                <span class="s2">&quot;Currently not supported.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">which</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;noise&quot;</span><span class="p">,</span> <span class="s2">&quot;flags&quot;</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Unknown which </span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">toload</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span> <span class="p">]</span> <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="p">[</span> <span class="n">which</span> <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">always_reload</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">toload</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">):</span>
                <span class="n">toload</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="s1">&#39;data&#39;</span> <span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
            <span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;noise&#39;</span> <span class="ow">in</span> <span class="n">toload</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">):</span>
                <span class="n">toload</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="s1">&#39;noise&#39;</span> <span class="p">)</span>
                <span class="n">noise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise</span>
            <span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;flags&#39;</span> <span class="ow">in</span> <span class="n">toload</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">):</span>
                <span class="n">toload</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span> <span class="s1">&#39;flags&#39;</span> <span class="p">)</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">toload</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If we get here, we know we have to load data.</span>

            <span class="c1"># Open the data, and do everything else inside that with just in case</span>
            <span class="c1">#   noise and flags are part of the same FITS image.</span>
            <span class="k">with</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="p">)</span> <span class="k">as</span> <span class="n">imagefits</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">toload</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">FITSImage</span><span class="o">.</span><span class="n">_fitsio_header_to_astropy_header</span><span class="p">(</span> <span class="n">imagefits</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagehdu</span> <span class="p">]</span><span class="o">.</span><span class="n">read_header</span><span class="p">()</span> <span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">imagefits</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagehdu</span> <span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_header</span> <span class="o">=</span> <span class="n">header</span>

                <span class="k">if</span> <span class="s2">&quot;noise&quot;</span> <span class="ow">in</span> <span class="n">toload</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisepath</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="p">):</span>
                        <span class="k">with</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisepath</span> <span class="p">)</span> <span class="k">as</span> <span class="n">noisefits</span><span class="p">:</span>
                            <span class="n">noise</span> <span class="o">=</span> <span class="n">noisefits</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisehdu</span> <span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">noise</span> <span class="o">=</span> <span class="n">imagefits</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisehdu</span> <span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_noise</span> <span class="o">=</span> <span class="n">noise</span>

                <span class="k">if</span> <span class="s2">&quot;flags&quot;</span> <span class="ow">in</span> <span class="n">toload</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="p">):</span>
                        <span class="k">with</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span> <span class="p">)</span> <span class="k">as</span> <span class="n">flagsfits</span><span class="p">:</span>
                            <span class="n">flags</span> <span class="o">=</span> <span class="n">flagsfits</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagshdu</span> <span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">flags</span> <span class="o">=</span> <span class="n">imagefits</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagshdu</span> <span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_flags</span> <span class="o">=</span> <span class="n">flags</span>

        <span class="k">return</span> <span class="p">(</span> <span class="p">[</span> <span class="n">data</span> <span class="p">]</span> <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span>
                 <span class="k">else</span> <span class="p">[</span> <span class="n">noise</span> <span class="p">]</span> <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;noise&quot;</span>
                 <span class="k">else</span> <span class="p">[</span> <span class="n">flags</span> <span class="p">]</span> <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s2">&quot;flags&quot;</span>
                 <span class="k">else</span> <span class="p">[</span> <span class="n">data</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">flags</span> <span class="p">]</span> <span class="p">)</span></div>



<div class="viewcode-block" id="FITSImageOnDisk.save">
<a class="viewcode-back" href="../../api/snappl.image.FITSImageOnDisk.html#snappl.image.FITSImageOnDisk.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imagehdu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">noisepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noisehdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">flagspath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flagshdu</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the data to the file.&quot;&quot;&quot;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
        <span class="n">noisepath</span> <span class="o">=</span> <span class="n">noisepath</span> <span class="k">if</span> <span class="n">noisepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">noisepath</span>
        <span class="n">flagspath</span> <span class="o">=</span> <span class="n">flagspath</span> <span class="k">if</span> <span class="n">flagspath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagspath</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span> <span class="p">(</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.fits&#39;</span> <span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span> <span class="n">path</span><span class="p">,</span> <span class="n">noisepath</span><span class="p">,</span> <span class="n">flagspath</span> <span class="p">]</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;I don&#39;t know how to save compressed files, only files &quot;</span>
                                       <span class="s2">&quot;whose names end in .fits&quot;</span> <span class="p">)</span>

        <span class="n">FITSImage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="n">which</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">noisepath</span><span class="o">=</span><span class="n">noisepath</span><span class="p">,</span> <span class="n">flagspath</span><span class="o">=</span><span class="n">flagspath</span><span class="p">,</span>
                        <span class="n">imagehdu</span><span class="o">=</span><span class="n">imagehdu</span><span class="p">,</span> <span class="n">noisehdu</span><span class="o">=</span><span class="n">noisehdu</span><span class="p">,</span> <span class="n">flagshdu</span><span class="o">=</span><span class="n">flagshdu</span> <span class="p">)</span></div>
</div>



<span class="c1"># ======================================================================</span>
<span class="c1"># OpenUniverse 2024 Images are gzipped FITS files</span>
<span class="c1">#  HDU 0 : (something, no data)</span>
<span class="c1">#  HDU 1 : SCI (32-bit float)</span>
<span class="c1">#  HDU 2 : ERR (32-bit float)</span>
<span class="c1">#  HDU 3 : DQ (32-bit integer)</span>

<div class="viewcode-block" id="OpenUniverse2024FITSImage">
<a class="viewcode-back" href="../../api/snappl.image.OpenUniverse2024FITSImage.html#snappl.image.OpenUniverse2024FITSImage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OpenUniverse2024FITSImage</span><span class="p">(</span> <span class="n">FITSImageOnDisk</span> <span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">noisepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flagspath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imagehdu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noisehdu</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">flagshdu</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                          <span class="n">noisepath</span><span class="o">=</span><span class="n">noisepath</span><span class="p">,</span> <span class="n">flagspath</span><span class="o">=</span><span class="n">flagspath</span><span class="p">,</span>
                          <span class="n">imagehdu</span><span class="o">=</span><span class="n">imagehdu</span><span class="p">,</span> <span class="n">noisehdu</span><span class="o">=</span><span class="n">noisehdu</span><span class="p">,</span> <span class="n">flagshdu</span><span class="o">=</span><span class="n">flagshdu</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

    <span class="n">_filenamere</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;^Roman_TDS_simple_model_(?P&lt;band&gt;[^_]+)_(?P&lt;pointing&gt;\d+)_(?P&lt;sca&gt;\d+).fits&#39;</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pointing</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pointing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Irritatingly, the pointing is not in the header.  So, we have to</span>
            <span class="c1">#   parse the filename to get the pointing.</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filenamere</span><span class="o">.</span><span class="n">search</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Failed to parse </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> for pointing&quot;</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pointing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">mat</span><span class="o">.</span><span class="n">group</span><span class="p">(</span> <span class="s1">&#39;pointing&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pointing</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sca</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sca</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sca</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;SCA_NUM&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sca</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">band</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The band the image is taken in (str).&quot;&quot;&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mjd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The mjd of the image.</span>

<span class="sd">        TODO : is this start-time, mid-time, or end-time?</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mjd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mjd</span> <span class="o">=</span>  <span class="nb">float</span><span class="p">(</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mjd</span>

    <span class="nd">@mjd</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mjd</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span> <span class="p">):</span>
        <span class="c1"># We need an MJD setter so that ImageCollection can set the MJD when fetching the images, much faster than</span>
        <span class="c1"># reading the header each time!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mjd</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">exptime</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="c1"># Galsim has fixed exptimes for roman filters</span>
        <span class="n">exptimes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F184&#39;</span><span class="p">:</span> <span class="mf">901.175</span><span class="p">,</span>
                   <span class="s1">&#39;J129&#39;</span><span class="p">:</span> <span class="mf">302.275</span><span class="p">,</span>
                   <span class="s1">&#39;H158&#39;</span><span class="p">:</span> <span class="mf">302.275</span><span class="p">,</span>
                   <span class="s1">&#39;K213&#39;</span><span class="p">:</span> <span class="mf">901.175</span><span class="p">,</span>
                   <span class="s1">&#39;R062&#39;</span><span class="p">:</span> <span class="mf">161.025</span><span class="p">,</span>
                   <span class="s1">&#39;Y106&#39;</span><span class="p">:</span> <span class="mf">302.275</span><span class="p">,</span>
                   <span class="s1">&#39;Z087&#39;</span><span class="p">:</span> <span class="mf">101.7</span> <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exptimes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Don&#39;t know exptime for band </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">exptimes</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">truthpath</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Path to truth catalog.  WARNING: this is OpenUniverse2024FITSImage-specific, use with care.&quot;&quot;&quot;</span>
        <span class="n">tds_base</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;system.ou24.tds_base&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span> <span class="n">tds_base</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;truth/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s1">/&#39;</span>
                 <span class="sa">f</span><span class="s1">&#39;Roman_TDS_index_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s1">.txt&#39;</span> <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_zeropoint</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fits_header</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">galsim</span><span class="o">.</span><span class="n">roman</span><span class="o">.</span><span class="n">getBandpasses</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">]</span><span class="o">.</span><span class="n">zeropoint</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ZPTMAG&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_zeropoint_the_hard_way</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="mi">9</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is here hopefully as legacy code.</span>

<span class="sd">        If, however, it turns out that</span>
<span class="sd">        galsim.roman.getBandpasses()[self.band].zeropoint +</span>
<span class="sd">        header[&#39;ZPTMAG&#39;] is not a good enough zeropoint, we may need to</span>
<span class="sd">        resort to this.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get stars from the truth</span>
        <span class="n">truth_colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;object_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;realized_flux&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="s1">&#39;obj_type&#39;</span><span class="p">]</span>
        <span class="n">truth_pd</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">truthpath</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">truth_colnames</span><span class="p">)</span>
        <span class="n">star_tab</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">truth_pd</span><span class="p">)</span>
        <span class="n">star_tab</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;mag_truth&#39;</span>
        <span class="n">star_tab</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;flux_truth&#39;</span>
        <span class="c1"># Gotta do the FITS vs. C offset</span>
        <span class="n">star_tab</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">star_tab</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">star_tab</span> <span class="o">=</span> <span class="n">star_tab</span><span class="p">[</span> <span class="p">(</span> <span class="n">star_tab</span><span class="p">[</span><span class="s1">&#39;obj_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;star&#39;</span> <span class="p">)</span>
                             <span class="o">&amp;</span> <span class="p">(</span> <span class="n">star_tab</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="n">star_tab</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
                             <span class="o">&amp;</span> <span class="p">(</span> <span class="n">star_tab</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="n">star_tab</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">]</span>


        <span class="n">init_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ap_phot</span><span class="p">(</span> <span class="n">star_tab</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="n">ap_r</span> <span class="p">)</span>
        <span class="c1"># Needs to be &#39;xcentroid&#39; and &#39;ycentroid&#39; for PSF photometry.</span>
        <span class="n">init_params</span><span class="p">[</span><span class="s1">&#39;object_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star_tab</span><span class="p">[</span><span class="s1">&#39;object_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">init_params</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span> <span class="s1">&#39;xcenter&#39;</span><span class="p">,</span> <span class="s1">&#39;xcentroid&#39;</span> <span class="p">)</span>
        <span class="n">init_params</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span> <span class="s1">&#39;ycenter&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span> <span class="p">)</span>
        <span class="n">init_params</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span> <span class="s1">&#39;aperture_sum&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_init&#39;</span> <span class="p">)</span>
        <span class="n">final_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_phot</span><span class="p">(</span> <span class="n">init_params</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">forced_phot</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="c1"># Do not need to cross match. Can just merge tables because they</span>
        <span class="c1"># will be in the same order.  Remove redundant column flux_init</span>
        <span class="n">final_params</span><span class="o">.</span><span class="n">remove_columns</span><span class="p">(</span> <span class="p">[</span> <span class="s1">&#39;flux_init&#39;</span><span class="p">]</span> <span class="p">)</span>
        <span class="n">photres</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">star_tab</span><span class="p">,</span> <span class="n">init_params</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object_id&#39;</span><span class="p">])</span>
        <span class="n">photres</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">photres</span><span class="p">,</span> <span class="n">final_params</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

        <span class="c1"># Get the zero point.</span>
        <span class="n">gs_zpt</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">roman</span><span class="o">.</span><span class="n">getBandpasses</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">]</span><span class="o">.</span><span class="n">zeropoint</span>
        <span class="n">area_eff</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">roman</span><span class="o">.</span><span class="n">collecting_area</span>
        <span class="n">star_ap_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">photres</span><span class="p">[</span><span class="s1">&#39;flux_init&#39;</span><span class="p">])</span>
        <span class="n">star_fit_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">photres</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">])</span>
        <span class="n">star_truth_mags</span> <span class="o">=</span> <span class="p">(</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">photres</span><span class="p">[</span><span class="s1">&#39;flux_truth&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">gs_zpt</span>
                            <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exptime</span> <span class="o">*</span> <span class="n">area_eff</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># Eventually, this should be a S/N cut, not a mag cut.</span>
        <span class="n">zpt_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">star_truth_mags</span> <span class="o">&gt;</span> <span class="mi">19</span><span class="p">,</span> <span class="n">star_truth_mags</span> <span class="o">&lt;</span> <span class="mf">21.5</span><span class="p">)</span>
        <span class="n">zpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">star_truth_mags</span><span class="p">[</span><span class="n">zpt_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">star_fit_mags</span><span class="p">[</span><span class="n">zpt_mask</span><span class="p">])</span>
        <span class="n">_ap_zpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">star_truth_mags</span><span class="p">[</span><span class="n">zpt_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">star_ap_mags</span><span class="p">[</span><span class="n">zpt_mask</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">zpt</span></div>



<span class="c1"># ======================================================================</span>
<span class="c1"># RomanDatamodelImage</span>
<span class="c1">#</span>
<span class="c1"># An image read from a roman datamodel ASDF file</span>
<span class="c1">#</span>
<span class="c1"># Empirically:</span>
<span class="c1">#   self._dm.err**2 == self._dm.var_poisson + self._dm.var_rnoise + self.dm.var_flat</span>

<div class="viewcode-block" id="RomanDatamodelImage">
<a class="viewcode-back" href="../../api/snappl.image.RomanDatamodelImage.html#snappl.image.RomanDatamodelImage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RomanDatamodelImage</span><span class="p">(</span> <span class="n">Image</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An image read from a roman datamodel ASDF file.</span>

<span class="sd">    See Issue #46 for concerns about performance/memory and imlementation of this object.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_detectormatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="s2">&quot;^WFI([0-9]</span><span class="si">{2}</span><span class="s2">)$&quot;</span> <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">path</span> <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span> <span class="n">path</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span> <span class="p">)</span>
        <span class="c1"># We really want to open the image readonly, because otherwise normal use of</span>
        <span class="c1">#   this class will modify the image on disk.  We really don&#39;t want to modify</span>
        <span class="c1">#   our input data, and want to be explicit about saving like we are used</span>
        <span class="c1">#   to with FITS files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dm</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span> <span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detectormatch</span><span class="o">.</span><span class="n">search</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;Failed to parse self._dm.meat.instrument.detector= &#39;</span>
                              <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">detector</span><span class="si">}</span><span class="s1"> for &quot;WFInn&quot;&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sca</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">band</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">optical_element</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">mjd</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">mid_time</span><span class="o">.</span><span class="n">mjd</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">data</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="c1"># WORRY.  This actually returns a asdf.tags.core.ndarray.NDArrayType.</span>
        <span class="c1"># I&#39;m hoping it will be duck-typing equivalent to a numpy array.</span>
        <span class="c1"># TODO : investigate memory use when you do numpy array things</span>
        <span class="c1"># with one of these.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">noise</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="c1"># See comment in data</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">err</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">flags</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="c1"># See comment in data</span>
        <span class="c1"># TODO : https://roman-pipeline.readthedocs.io/en/latest/roman/dq_init/reference_files.html#reference-files</span>
        <span class="c1"># We probably need to do some translation.  We have to think about what we are defining</span>
        <span class="c1">#   as a &quot;bad&quot; pixel.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">dq</span>

<div class="viewcode-block" id="RomanDatamodelImage.get_data">
<a class="viewcode-back" href="../../api/snappl.image.RomanDatamodelImage.html#snappl.image.RomanDatamodelImage.get_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">always_reload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read the data from disk and return one or more 2d numpy arrays of data.</span>

<span class="sd">        See Image.get_data for definition of parameters.</span>

<span class="sd">        Subclass-specific wrinkle:</span>

<span class="sd">        get_data will return actual 2d numpy arrays, which means that</span>
<span class="sd">        the memory will always be copied from what is stored from the</span>
<span class="sd">        open roman_datamodels file.  We may revisit this later as we</span>
<span class="sd">        think about memory implications.  (Issue #46.)</span>

<span class="sd">        Once you get the data, it will always be cached, even if you</span>
<span class="sd">        pass cache=False.  (This is because we keep the roman_datamodels</span>
<span class="sd">        file open, and currently there&#39;s no way to free the data without</span>
<span class="sd">        closing and reopening the file.)  So, cache=False does not save</span>
<span class="sd">        any memory, alas.  (Again, Issue #46.)</span>

<span class="sd">        As such, always_reload and cache are ignored for this class.</span>
<span class="sd">        This is not great, because always_reload ought to get a fresh</span>
<span class="sd">        copy of the data even if it&#39;s been modified.  To really behave</span>
<span class="sd">        that way, though, we&#39;d have to reimplement the class to not hold</span>
<span class="sd">        open the roman_datamodels image.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_cutout</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> images don&#39;t know how to deal with being cutouts.&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;noise&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">)</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;flags&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span> <span class="p">]</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Unknown value of which: </span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span></div>



    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dm</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;This property should usually not be used outside of this class.&quot;&quot;&quot;</span>
        <span class="c1"># THOUGHT REQUIRED : worry a little about accessing members of</span>
        <span class="c1">#   the dm object and memory getting eaten.  Perhaps implement</span>
        <span class="c1">#   a &quot;free&quot; method for Image and subclasses.  Alas, for this</span>
        <span class="c1">#   class, based on feedback from ST people, the only way to free</span>
        <span class="c1">#   things is to delete and reopen the self._dm object.  Make sure</span>
        <span class="c1">#   to do that carefully if we do that.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dm</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">path</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dm</span>

<div class="viewcode-block" id="RomanDatamodelImage.get_wcs">
<a class="viewcode-back" href="../../api/snappl.image.RomanDatamodelImage.html#snappl.image.RomanDatamodelImage.get_wcs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_wcs</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">wcsclass</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="n">wcsclass</span> <span class="o">=</span> <span class="s2">&quot;GWCS&quot;</span> <span class="k">if</span> <span class="n">wcsclass</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">wcsclass</span>
        <span class="k">if</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="n">wcsclass</span> <span class="p">):</span>
            <span class="k">if</span> <span class="n">wcsclass</span> <span class="o">==</span> <span class="s2">&quot;GWCS&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span> <span class="o">=</span> <span class="n">GWCS</span><span class="p">(</span> <span class="n">gwcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;RomanDataModelImage can&#39;t (yet?) get a WCS of type </span><span class="si">{wcsclass}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wcs</span></div>
</div>

</pre></div>

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2025, Roman Supernova PIT.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>