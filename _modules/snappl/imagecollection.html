<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>snappl.imagecollection &#8212; roman_snpit_snappl 0.1.dev1+g81f356707 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=5a6b8c39" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=f3bc516d" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <script src="../../_static/documentation_options.js?v=5cf180b2"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo_black_filled.png" alt="Logo" />
    
  </a>
</p>



<p class="blurb">Software developed by the Roman SNPIT</p>






<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">snappl API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../database_schema.html">Database Schema</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <h1>Source code for snappl.imagecollection</h1><div class="highlight"><pre>
<span></span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;ImageCollection&#39;</span><span class="p">,</span> <span class="s1">&#39;ImageCollectionOU2024&#39;</span><span class="p">,</span> <span class="s1">&#39;ImageCollectionManualFITS&#39;</span><span class="p">,</span> <span class="s1">&#39;ImageCollectionDB&#39;</span> <span class="p">]</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">simplejson</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">retry_post</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.image</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenUniverse2024FITSImage</span><span class="p">,</span> <span class="n">FITSImage</span><span class="p">,</span> <span class="n">FITSImageStdHeaders</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.provenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">Provenance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.dbclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">SNPITDBClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">asUUID</span><span class="p">,</span> <span class="n">SNPITJsonEncoder</span>


<div class="viewcode-block" id="ImageCollection">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollection.html#snappl.imagecollection.ImageCollection">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImageCollection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class that keeps track of groups of images.</span>

<span class="sd">    Never instantiate an object of this class of its subclasses</span>
<span class="sd">    directly.  Call the get_collection() class method go get your image</span>
<span class="sd">    collection.</span>

<span class="sd">    Available properties include:</span>

<span class="sd">    base_path : pathlib.Path ; image paths are relative to this absolute path.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ImageCollection.get_collection">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollection.html#snappl.imagecollection.ImageCollection.get_collection">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_collection</span><span class="p">(</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;snpitdb&#39;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">provenance_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">process</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">provenance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">dbclient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get an ImageCollection object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          collection : str</span>
<span class="sd">            Name of the collection.  Currently defined collections:</span>
<span class="sd">            * ou2024 - Open Universe 2024 FITS images</span>
<span class="sd">            * manual_fits - FITS images that aren&#39;t really part of a collection</span>
<span class="sd">            * snpitdb - Images from Roman SNPIT internal DB.</span>

<span class="sd">          subset : str or None</span>
<span class="sd">            Name of the subset, if relevant for that collection.</span>
<span class="sd">              * manual_fits</span>
<span class="sd">                 * (None) - a single FITS file on disk</span>
<span class="sd">                 * &quot;threefile&quot; - follows the convention of snappl.image.FITSImageStdHeaders</span>
<span class="sd">                                 and std_imagenames=True passed to the constructor</span>

<span class="sd">          provenance_tag : str, defanot None</span>
<span class="sd">            The Roman SNPIT internal database provenance tag for the</span>
<span class="sd">            provenance of the images.  Either provenance_tag or</span>
<span class="sd">            provenance is required when collection is &#39;snpitdb&#39;.</span>
<span class="sd">            Invalid if collection is not &#39;snpitdb&#39;.</span>

<span class="sd">          process : str, default None</span>
<span class="sd">            The process to go with provenance_tag; required when</span>
<span class="sd">            provenance_tag is not None.</span>

<span class="sd">          provenance : Provenance or UUID or str, default None</span>
<span class="sd">            The Roman SNPIT internal database Provenance or provenance</span>
<span class="sd">            id for the images.  Either provenance_tag or provenance is</span>
<span class="sd">            required when collection is &#39;snpitdb&#39;.  Invalid if</span>
<span class="sd">            collection is not &#39;snpitdb&#39;.</span>

<span class="sd">          dbclient : SNPITDBClient, default None</span>
<span class="sd">            Only needed if collection is &#39;snpit&#39;.  If None, a new one</span>
<span class="sd">            will be made when needed.</span>

<span class="sd">          **kwargs : Some collections types require additional arguments.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s1">&#39;snpitdb&#39;</span><span class="p">:</span>
            <span class="n">dbclient</span> <span class="o">=</span> <span class="n">SNPITDBClient</span><span class="p">()</span> <span class="k">if</span> <span class="n">dbclient</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dbclient</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">provenance</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="n">provenance_tag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s1">&#39;Collection snpitdb requires either provenance_tag or provenance&#39;</span> <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">provenance_tag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="o">!=</span> <span class="p">(</span> <span class="n">process</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s1">&#39;Must specify either both or neither or provenance_tag and process&#39;</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">provenance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">provenance</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_provs_for_tag</span><span class="p">(</span> <span class="n">provenance_tag</span><span class="p">,</span> <span class="n">process</span><span class="o">=</span><span class="n">process</span><span class="p">,</span> <span class="n">dbclient</span><span class="o">=</span><span class="n">dbclient</span> <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">provenance</span><span class="p">,</span> <span class="n">Provenance</span> <span class="p">):</span>
                <span class="n">provenance</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">provenance</span><span class="p">,</span> <span class="n">dbclient</span><span class="o">=</span><span class="n">dbclient</span> <span class="p">)</span>

            <span class="k">return</span> <span class="n">ImageCollectionDB</span><span class="p">(</span> <span class="n">provenance</span><span class="o">=</span><span class="n">provenance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

        <span class="c1"># If we get here, we know collection isn&#39;t &#39;snpitdb&#39;</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span> <span class="n">provenance_tag</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">provenance</span> <span class="p">]</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;provenance_tag, process, and provenance are only valid for collection snpitdb&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">collection</span> <span class="o">==</span> <span class="s1">&#39;ou2024&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ImageCollectionOU2024</span><span class="p">(</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>

        <span class="k">elif</span> <span class="n">collection</span> <span class="o">==</span> <span class="s1">&#39;manual_fits&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ImageCollectionManualFITS</span><span class="p">(</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">subset</span> <span class="o">==</span> <span class="s2">&quot;threefile&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ImageCollectionManualFITS</span><span class="p">(</span> <span class="n">threefile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Unknown subset </span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2"> of manual_fits&quot;</span> <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Unknown image collection </span><span class="si">{</span><span class="n">collection</span><span class="si">}</span><span class="s2"> (subset </span><span class="si">{</span><span class="n">subset</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="p">)</span></div>


<div class="viewcode-block" id="ImageCollection.get_image">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollection.html#snappl.imagecollection.ImageCollection.get_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pointing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbclient</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an object of a subclass of Image based on input parameters.</span>

<span class="sd">        You can specify an image by:</span>
<span class="sd">          * image_id  (for collections that point to the internal Roman SNPIT database)</span>
<span class="sd">          * path</span>
<span class="sd">          * pointing, band, and sca</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          image_id : UUID or str, default None</span>
<span class="sd">            The id of the image you want to get.  This is only relevant</span>
<span class="sd">            for image collections that refer to images in the internal</span>
<span class="sd">            Roman SNPIT database, otherwise it is invalid.  If image_id</span>
<span class="sd">            is given, then path, pointing, band, and sca are all ignored.</span>

<span class="sd">          path: Path or str, default None</span>
<span class="sd">            The path to the relative to base_path.  For some subclasses,</span>
<span class="sd">            this must be consistent wiht pointing, band, and sca if passed.</span>

<span class="sd">          pointing: str, default None</span>
<span class="sd">            Pointing.  If not given, just use the Path to find the image.</span>

<span class="sd">          band: str, default None</span>
<span class="sd">            Band.</span>

<span class="sd">          sca: int, default None</span>
<span class="sd">            SCA.</span>

<span class="sd">          base_path: str or pathlib.Path, default None</span>
<span class="sd">            The base path for the image collection.  If not given, use</span>
<span class="sd">            the default for the collection from when the collection</span>
<span class="sd">            object was instantiated.</span>

<span class="sd">          dbclient : SNPITDBClient, default None</span>
<span class="sd">            Only relevant for image collections that refer to the</span>
<span class="sd">            internal SNPIT database.  If None, a new connection will be</span>
<span class="sd">            made if needed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          image: Image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;get_image not implemented for f</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span></div>



<div class="viewcode-block" id="ImageCollection.get_image_path">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollection.html#snappl.imagecollection.ImageCollection.get_image_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_path</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">pointing</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the absolute path to the desired image, if that makes sense.</span>

<span class="sd">        This will only make sense for image collections where an image</span>
<span class="sd">        is uniquely defined by a pointing, band, and sca.  Other image</span>
<span class="sd">        collections will just not implement this method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          pointing: str</span>
<span class="sd">            The pointing number</span>

<span class="sd">          band : str</span>
<span class="sd">            The band</span>

<span class="sd">          sca: int</span>
<span class="sd">            The SCA</span>

<span class="sd">          base_path : str or Path, default None</span>
<span class="sd">            If None, use the default value for this collection</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          pathlib.Path</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> doesn&#39;t implement get_image_path&quot;</span> <span class="p">)</span></div>



<div class="viewcode-block" id="ImageCollection.find_images">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollection.html#snappl.imagecollection.ImageCollection.find_images">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_images</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find images.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          path: pathlib.Path or str, default None</span>
<span class="sd">            Relative path of the image to search for.  Usually if you</span>
<span class="sd">            feed it this, you don&#39;t want to feed it nay other</span>
<span class="sd">            parameters.</span>

<span class="sd">          mjd_min : float, default None</span>
<span class="sd">            Only return images at this mjd or later</span>

<span class="sd">          mjd_max : float, default None</span>
<span class="sd">            Only return images at this mjd or earlier.</span>

<span class="sd">          ra: float, default None</span>
<span class="sd">            Only return images that contain this ra</span>

<span class="sd">          dec: float, default None</span>
<span class="sd">            Only return images that containe this dec</span>

<span class="sd">          band: str, default None</span>
<span class="sd">            Only include images from this band</span>

<span class="sd">          exptime_min: float, default None</span>
<span class="sd">            Only include images with at least this exptime in seconds.</span>

<span class="sd">          exptime_max: float, default None</span>
<span class="sd">            Only include images with at most this exptime in seconds.</span>

<span class="sd">          sca: int</span>
<span class="sd">            Only include images from this sca.</span>

<span class="sd">          order_by: str or list, default None</span>
<span class="sd">            By default, the returned images are not sorted in any</span>
<span class="sd">            particular way.  Put a keyword here to sort by that value</span>
<span class="sd">            (or by those values).  Options include &#39;id&#39;,</span>
<span class="sd">            &#39;provenance_id&#39;, &#39;pointing&#39;, &#39;sca&#39;, &#39;ra&#39;, &#39;dec&#39;, &#39;filepath&#39;,</span>
<span class="sd">            &#39;width&#39;, &#39;height&#39;, &#39;mjd&#39;, &#39;exptime&#39;.  Not all of these are</span>
<span class="sd">            necessarily useful, and some of them may be null for many</span>
<span class="sd">            objects in the database.</span>

<span class="sd">          limit : int, default None</span>
<span class="sd">            Only return this many objects at most.</span>

<span class="sd">          offset : int, default None</span>
<span class="sd">            Useful with limit and order_by ; offset the returned value</span>
<span class="sd">            by this many entries.  You can make repeated calls to</span>
<span class="sd">            find_objects to get subsets of objects by passing the same</span>
<span class="sd">            order_by and limit, but different offsets each time, to</span>
<span class="sd">            slowly build up a list.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          imagelist: list of snappl.image.Image</span>
<span class="sd">            Really it will be list of objects of a subclass of</span>
<span class="sd">            snappl.image.Image, but you shouldn&#39;t need to know that.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> needs to implement find_images&quot;</span> <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ImageCollectionOU2024">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionOU2024.html#snappl.imagecollection.ImageCollectionOU2024">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImageCollectionOU2024</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collection of OpenUnivers 2024 FITS images.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_path</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">base_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">base_path</span> <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">base_path</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;system.ou24.images&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_path</span>

<div class="viewcode-block" id="ImageCollectionOU2024.get_image">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionOU2024.html#snappl.imagecollection.ImageCollectionOU2024.get_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pointing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbclient</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a OpenUniverse2024FITSImage based on specifications.</span>

<span class="sd">        If you specify all of path, pointing, band, and sca, they must</span>
<span class="sd">        be consistent.</span>

<span class="sd">        If you just give path, then pointing, band, and sca will be read</span>
<span class="sd">        from the header.</span>

<span class="sd">        If you give pointinb, band, and sca, but not path, it will use</span>
<span class="sd">        get_image_path to find the image.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">image_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;image_id is invalid for ImageCollectionOU2024&quot;</span> <span class="p">)</span>

        <span class="n">base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="k">if</span> <span class="n">base_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">base_path</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">OpenUniverse2024FITSImage</span><span class="p">(</span> <span class="n">base_path</span> <span class="o">/</span> <span class="n">path</span> <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">pointing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">pointing</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">pointing</span><span class="p">)</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Pointing </span><span class="si">{pointing}</span><span class="s2"> inconsistent with what&#39;s in </span><span class="si">{path}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">sca</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">sca</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">sca</span><span class="p">)</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;SCA </span><span class="si">{sca}</span><span class="s2"> inconsistent with what&#39;s in </span><span class="si">{path}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">band</span><span class="p">)</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Band </span><span class="si">{band}</span><span class="s2"> inconsistent with what&#39;s in </span><span class="si">{path}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">img</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span> <span class="n">pointing</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">sca</span> <span class="p">]</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Must specify either path or all of (pointing, band, sca)&quot;</span> <span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_path</span><span class="p">(</span> <span class="n">pointing</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="n">base_path</span> <span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">OpenUniverse2024FITSImage</span><span class="p">(</span> <span class="n">path</span><span class="p">,</span> <span class="n">pointing</span><span class="o">=</span><span class="n">pointing</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="n">sca</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">img</span></div>



<div class="viewcode-block" id="ImageCollectionOU2024.get_image_path">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionOU2024.html#snappl.imagecollection.ImageCollectionOU2024.get_image_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_path</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">pointing</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the absolute path to the desired OU2024 FITS image.</span>

<span class="sd">        See ImageCollection.get_image_path for documentation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="k">if</span> <span class="n">base_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">base_path</span> <span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">(</span> <span class="n">base_path</span> <span class="o">/</span> <span class="n">band</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">pointing</span><span class="p">)</span> <span class="o">/</span>
                 <span class="sa">f</span><span class="s1">&#39;Roman_TDS_simple_model_</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">pointing</span><span class="p">)</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">sca</span><span class="p">)</span><span class="si">}</span><span class="s1">.fits.gz&#39;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>


<div class="viewcode-block" id="ImageCollectionOU2024.find_images">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionOU2024.html#snappl.imagecollection.ImageCollectionOU2024.find_images">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_images</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span>
                      <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">mjd_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">mjd_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">ra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">dec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">exptime_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">exptime_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">sca</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">ra</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="o">!=</span> <span class="p">(</span> <span class="n">dec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Specify either both or neither of ra and dec&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;containing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">mjd_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mjd_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mjd_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mjd_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;mjd_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mjd_max</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exptime_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;exptime_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">exptime_min</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exptime_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;exptime_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">exptime_max</span><span class="p">)</span>

        <span class="n">simdex</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;system.ou24.simdex_server&#39;</span> <span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">retry_post</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">simdex</span><span class="si">}</span><span class="s2">/findromanimages&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">params</span> <span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;pointing&#39;</span><span class="p">])</span> <span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_path</span><span class="p">(</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;pointing&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;sca&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">OpenUniverse2024FITSImage</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;sca&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">image</span><span class="o">.</span><span class="n">mjd</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">image</span> <span class="p">)</span>


        <span class="k">return</span> <span class="n">images</span></div>
</div>




<div class="viewcode-block" id="ImageCollectionManualFITS">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionManualFITS.html#snappl.imagecollection.ImageCollectionManualFITS">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImageCollectionManualFITS</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manually specified custom images.</span>

<span class="sd">    One version of this (constructed with threefile=True) assumes that</span>
<span class="sd">    there are three files associated with an image whose path is given</span>
<span class="sd">    as {path}::</span>

<span class="sd">       {path}_image.fits</span>
<span class="sd">       {path}_noise.fits</span>
<span class="sd">       {path}_flags.fits</span>

<span class="sd">    In addition, the threefile version assumes that the following header</span>
<span class="sd">    keywords all exist in the header of the _image.fits file::</span>

<span class="sd">      BAND</span>
<span class="sd">      EXPTIME</span>
<span class="sd">      MJD</span>
<span class="sd">      POINTING</span>
<span class="sd">      SCA</span>
<span class="sd">      ZPT</span>

<span class="sd">    (in addition to a WCS in the _image.fits header).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threefile</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">base_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;manual_fits collection needs a base path&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">base_path</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threefile</span> <span class="o">=</span> <span class="n">threefile</span>

<div class="viewcode-block" id="ImageCollectionManualFITS.get_image_path">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionManualFITS.html#snappl.imagecollection.ImageCollectionManualFITS.get_image_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_path</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">pointing</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;get_image_path is not defined for ImageCollectionManualFITS&quot;</span> <span class="p">)</span></div>


<div class="viewcode-block" id="ImageCollectionManualFITS.find_images">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionManualFITS.html#snappl.imagecollection.ImageCollectionManualFITS.find_images">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_images</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;find_images is not defined for ImageCollectionManualFITS&quot;</span> <span class="p">)</span></div>


<div class="viewcode-block" id="ImageCollectionManualFITS.get_image">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionManualFITS.html#snappl.imagecollection.ImageCollectionManualFITS.get_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pointing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbclient</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">image_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;image_id is invalid for ImageCollectionManualFITS&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;ImageCollectionManualFITS.get_image requires a path, it can&#39;t &quot;</span>
                              <span class="s2">&quot;handle pointing/band/sca.&quot;</span> <span class="p">)</span>

        <span class="n">base_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">base_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">base_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threefile</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FITSImageStdHeaders</span><span class="p">(</span> <span class="n">path</span><span class="o">=</span><span class="n">base_path</span> <span class="o">/</span> <span class="n">path</span><span class="p">,</span> <span class="n">std_imagenames</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FITSImage</span><span class="p">(</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span> <span class="p">)</span></div>
</div>



<span class="c1"># ======================================================================</span>
<span class="c1"># Images that are in the Roman SNPIT Database</span>

<div class="viewcode-block" id="ImageCollectionDB">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionDB.html#snappl.imagecollection.ImageCollectionDB">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImageCollectionDB</span><span class="p">:</span>
    <span class="n">image_class_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;ou2024&#39;</span><span class="p">:</span> <span class="n">OpenUniverse2024FITSImage</span><span class="p">,</span>
                         <span class="s1">&#39;ou2024nov2025&#39;</span><span class="p">:</span> <span class="n">OpenUniverse2024FITSImage</span>
                        <span class="p">}</span>
    <span class="n">base_path_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;ou2024&#39;</span><span class="p">:</span> <span class="s1">&#39;system.ou24.images&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ou2024nov2025&#39;</span><span class="p">:</span> <span class="s1">&#39;system.paths.images&#39;</span>
                      <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">provenance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="k">if</span> <span class="n">provenance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;provenance is required&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provenance</span> <span class="o">=</span> <span class="n">provenance</span>

        <span class="n">prov_imclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;image_class&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">prov_imclass</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_class_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;Unknown image_class </span><span class="si">{image_class}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_class_dict</span><span class="p">[</span> <span class="n">prov_imclass</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">base_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path_dict</span><span class="p">[</span> <span class="n">prov_imclass</span> <span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">base_path</span> <span class="p">)</span>


<div class="viewcode-block" id="ImageCollectionDB.get_image">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionDB.html#snappl.imagecollection.ImageCollectionDB.get_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">image_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pointing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dbclient</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="n">dbclient</span> <span class="o">=</span> <span class="n">SNPITDBClient</span><span class="p">()</span> <span class="k">if</span> <span class="n">dbclient</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dbclient</span>

        <span class="k">if</span> <span class="n">image_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">dbclient</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;/getl2image/</span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">asUUID</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;provenance_id&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Asked for image </span><span class="si">{</span><span class="n">image_id</span><span class="si">}</span><span class="s2"> in provenance </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, but that image &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;actually has provenance </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;provenance_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="p">(</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">)</span> <span class="ow">or</span>
                     <span class="p">(</span> <span class="nb">all</span><span class="p">(</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span> <span class="n">pointing</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">sca</span> <span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Must specify one of image_id, path, or (pointing, band, and sca).&quot;</span> <span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span> <span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">,</span> <span class="s1">&#39;pointing&#39;</span><span class="p">,</span> <span class="s1">&#39;band&#39;</span><span class="p">,</span> <span class="s1">&#39;sca&#39;</span> <span class="p">],</span>
                                           <span class="p">[</span><span class="n">path</span><span class="p">,</span> <span class="n">pointing</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">sca</span> <span class="p">]</span> <span class="p">)</span>
                     <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">}</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">dbclient</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;/findl2images/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                  <span class="n">data</span><span class="o">=</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">SNPITJsonEncoder</span> <span class="p">),</span>
                                  <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span> <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Image not found for provenance </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Multiple images found for provenance </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

            <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_class</span><span class="p">(</span> <span class="o">**</span><span class="n">row</span> <span class="p">)</span></div>



<div class="viewcode-block" id="ImageCollectionDB.get_image_path">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionDB.html#snappl.imagecollection.ImageCollectionDB.get_image_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_path</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">pointing</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">image_id</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span> <span class="s2">&quot;Not implemented yet, may not be...&quot;</span> <span class="p">)</span></div>



<div class="viewcode-block" id="ImageCollectionDB.find_images">
<a class="viewcode-back" href="../../api/snappl.imagecollection.ImageCollectionDB.html#snappl.imagecollection.ImageCollectionDB.find_images">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_images</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">dbclient</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">):</span>
        <span class="n">dbclient</span> <span class="o">=</span> <span class="n">SNPITDBClient</span><span class="p">()</span> <span class="k">if</span> <span class="n">dbclient</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dbclient</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">dbclient</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;findl2images/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provenance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="n">data</span><span class="o">=</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="n">kwargs</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">SNPITJsonEncoder</span> <span class="p">),</span>
                              <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">}</span> <span class="p">)</span>

        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span>
            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_class</span><span class="p">(</span> <span class="o">**</span><span class="n">row</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">images</span></div>
</div>

</pre></div>

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2025, Roman Supernova PIT.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>