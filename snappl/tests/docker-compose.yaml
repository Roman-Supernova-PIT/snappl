# This is a compose file that creates an environment in which you can
# run tests.  For all the tests to work, you must check out
#
#   https://github.com/Roman-Supernova-PIT/phtometry_test_data
#
# in the same place you checked out snappl.  That is, there should be a
# directory on your system with subdirectories snappl and
# photometry_test_data, and relative to that directory this file you're
# reading should be snappl/snappl/tests/docker_compose.yaml
#
# Once you've set that up, either just do
#
#   docker compose run runtests
#
# or, do
#
#   docker compose up -d shell
#
# to get a shell session running the SNPIT cpu image.  Connect to it
# with
#
#   docker compose exec -it shell /bin/bash
#
# You can now do things in there, including
#
#   cd /snappl/snappl/tests
#   pytest -v

services:
  shell:
    image: rknop/roman-snpit-env:cpu-dev
    entrypoint: [ "tail", "-f", "/etc/issue" ]
    working_dir: /snappl
    volumes:
      - type: bind
        source: ../..
        target: /snappl
      - type: bind
        source: ../../../photometry_test_data
        target: /photometry_test_data

  runtests:
    image: rknop/roman-snpit-env:cpu-dev
    working_dir: /snappl
    environment:
      GITHUB_SKIP: 1
    entrypoint:
      - /bin/sh
      - -c
      - |
        pip install --no-deps -e . &&
        cd snappl/tests &&
        pytest -v
    volumes:
      - type: bind
        source: ../..
        target: /snappl
      - type: bind
        source: ../../../photometry_test_data
        target: /photometry_test_data

