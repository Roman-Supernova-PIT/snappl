<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Usage &#8212; roman_snpit_snappl 0.1.dev1+g7a9148e78 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=5a6b8c39" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=f3bc516d" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
    <script src="_static/documentation_options.js?v=61eb2865"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Change Log" href="changes.html" />
    <link rel="prev" title="Installation" href="installation.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logo_black_filled.png" alt="Logo" />
    
  </a>
</p>



<p class="blurb">Software developed by the Roman SNPIT</p>






<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="changes.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">snappl API</a></li>
<li class="toctree-l1"><a class="reference internal" href="database_schema.html">Database Schema</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="installation.html" title="previous chapter">Installation</a></li>
      <li>Next: <a href="changes.html" title="next chapter">Change Log</a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="installation.html" title="Previous document">Installation</a>
        </li>
        <li>
          <a href="changes.html" title="Next document">Change Log</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <section id="usage">
<h1><a class="toc-backref" href="#id6" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Link to this heading">¶</a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#usage" id="id6">Usage</a></p>
<ul>
<li><p><a class="reference internal" href="#overview" id="id7">Overview</a></p></li>
<li><p><a class="reference internal" href="#november-2025-snpit-pipeline-test-primer" id="id8">November 2025 SNPIT Pipeline Test Primer</a></p>
<ul>
<li><p><a class="reference internal" href="#recipes" id="id9">Recipes</a></p>
<ul>
<li><p><a class="reference internal" href="#prerequisites" id="id10">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#variables-arguments-for-ids-and-provenances" id="id11">Variables/Arguments for IDs and Provenances</a></p></li>
<li><p><a class="reference internal" href="#finding-a-diaobject" id="id12">Finding a DiaObject</a></p></li>
<li><p><a class="reference internal" href="#getting-an-updated-diaobject-position" id="id13">Getting an updated diaobject position</a></p></li>
<li><p><a class="reference internal" href="#getting-a-specific-image" id="id14">Getting a Specific Image</a></p></li>
<li><p><a class="reference internal" href="#finding-images" id="id15">Finding Images</a></p>
<ul>
<li><p><a class="reference internal" href="#finding-all-images-in-a-given-band-that-include-a-ra-and-dec" id="id16">Finding all images in a given band that include a ra and dec</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#finding-segmentation-maps" id="id17">Finding Segmentation Maps</a></p>
<ul>
<li><p><a class="reference internal" href="#finding-all-segmaps-that-include-a-ra-and-dec" id="id18">Finding all segmaps that include a ra and dec</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#saving-a-new-diaobject" id="id19">Saving a new DiaObject</a></p></li>
<li><p><a class="reference internal" href="#finding-and-reading-lightcurves" id="id20">Finding and reading lightcurves</a></p></li>
<li><p><a class="reference internal" href="#saving-lightcurves" id="id21">Saving lightcurves</a></p></li>
<li><p><a class="reference internal" href="#finding-and-reading-1d-spectra" id="id22">Finding and reading 1d Spectra</a></p></li>
<li><p><a class="reference internal" href="#saving-1d-spectra" id="id23">Saving 1d Spectra</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#choose-a-working-environment" id="id24">Choose a working environment</a></p></li>
<li><p><a class="reference internal" href="#making-provenances" id="id25">Making Provenances</a></p></li>
<li><p><a class="reference internal" href="#provenance-tags-we-will-use-in-november-2025" id="id26">Provenance Tags We Will Use In November 2025</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#connecting-to-the-database" id="id27">Connecting to the Database</a></p></li>
<li><p><a class="reference internal" href="#config" id="id28">Config</a></p>
<ul>
<li><p><a class="reference internal" href="#the-default-confg" id="id29">The Default Confg</a></p></li>
<li><p><a class="reference internal" href="#using-config" id="id30">Using Config</a></p>
<ul>
<li><p><a class="reference internal" href="#overriding-parameters-on-the-command-line" id="id31">Overriding Parameters on the Command Line</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#provenance" id="id32">Provenance</a></p>
<ul>
<li><p><a class="reference internal" href="#provenance-tags" id="id33">Provenance Tags</a></p></li>
<li><p><a class="reference internal" href="#getting-provenances-from-the-database" id="id34">Getting Provenances from the Database</a></p></li>
<li><p><a class="reference internal" href="#parameters" id="id35">Parameters</a></p></li>
<li><p><a class="reference internal" href="#upstreams" id="id36">Upstreams</a></p></li>
<li><p><a class="reference internal" href="#creating-a-provenance" id="id37">Creating a Provenance</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-roman-snpit-test-environment" id="id38">The Roman SNPIT Test Environment</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">snappl</span></code> has a set of utilities for the Roman SNPIT, including all the classes and functions necessary for communicating with the internal snpit database.</p>
<p>If you’re here for the SNPIT November 2025 pipeline test, see <a class="reference internal" href="#nov2025"><span class="std std-ref">November 2025 SNPIT Pipeline Test Primer</span></a>.</p>
<dl class="simple">
<dt>Things you need to understand:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#connecting-to-the-database"><span class="std std-ref">Connecting to the Database</span></a></p></li>
<li><p><a class="reference internal" href="#config"><span class="std std-ref">Config</span></a></p></li>
<li><p><a class="reference internal" href="#provenance"><span class="std std-ref">Provenance</span></a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="november-2025-snpit-pipeline-test-primer">
<span id="nov2025"></span><h2><a class="toc-backref" href="#id8" role="doc-backlink">November 2025 SNPIT Pipeline Test Primer</a><a class="headerlink" href="#november-2025-snpit-pipeline-test-primer" title="Link to this heading">¶</a></h2>
<p>The database connection is under heavy development, and more things are showing up every day.  Right now, the following is available:</p>
<ul class="simple">
<li><p>Find image L2 images in the database</p></li>
<li><p>Find segmentation maps in the database</p></li>
<li><p>Saving newly discovered DiaObjects to the database</p></li>
<li><p>Finding DiaObjects</p></li>
<li><p>Saving updated positions for DiaObjects</p></li>
<li><p>Saving lightcurves to the database</p></li>
<li><p>Finding and reading lightcurves from the database</p></li>
<li><p>Saving 1d transient spectra to the database</p></li>
<li><p>Finding and reading 1d transient spectra from the database</p></li>
</ul>
<p>This section describes what you need to do in order to connect to the database.</p>
<p><strong>WARNING</strong>: because everything is under heavy development, it’s possible that interfaces will change.  We will try to avoid doing this, because it’s a pain when everybody has to adapt, but we’re still building this, so it may be inevitable.</p>
<section id="recipes">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Recipes</a><a class="headerlink" href="#recipes" title="Link to this heading">¶</a></h3>
<p>Read everything to understand what’s going on, but these are intended as a quick start.</p>
<section id="prerequisites">
<h4><a class="toc-backref" href="#id10" role="doc-backlink">Prerequisites</a><a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h4>
<p>These recipes assume you have a working environment (see <a class="reference internal" href="#nov2025-working-env"><span class="std std-ref">Choose a working environment</span></a>), which hopefully is as simple as <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">roman-snpit-snappl</span></code>, but see that section for all the details and where you eventually need to be heading.</p>
<p>They also assume you have set up a config file.  If you’re on NERSC, <em>not</em> running in a container, then save <a class="reference external" href="https://raw.githubusercontent.com/Roman-Supernova-PIT/environment/refs/heads/main/nov2025_nersc_native_config.yaml">the config file for running natively on NERSC</a>.  (This is the file <code class="docutils literal notranslate"><span class="pre">nov2025_nersc_native_config.yaml</span></code> from the top level of the <code class="docutils literal notranslate"><span class="pre">environment</span></code> roman snpit github archive).  Note that you will need to do two small edits in this file!  If you are running in a podman container, then look at <a class="reference external" href="https://raw.githubusercontent.com/Roman-Supernova-PIT/environment/refs/heads/main/nov2025_container_config.yaml">the in-container config file</a>. (This is the file <code class="docutils literal notranslate"><span class="pre">nov2025_nersc_container_config.yaml</span></code> from the top level of the <code class="docutils literal notranslate"><span class="pre">environment</span></code> roman snpit github archive); you will also need to download <a class="reference external" href="https://raw.githubusercontent.com/Roman-Supernova-PIT/environment/refs/heads/main/interactive-podman-nov2025.sh">interactive-podman-nov2025.sh</a>.   If you are elsewhere, you will need to edit the config file to have the right paths to find things on your system.</p>
<p>You need to set the environment variable <code class="docutils literal notranslate"><span class="pre">SNPIT_CONFIG</span></code> to point to where this configuration file lives.</p>
<p>Finally, once at the top of your code you need to do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.dbclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">SNPITDBClient</span>

<span class="n">dbclient</span> <span class="o">=</span> <span class="n">SNPITDBClient</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
<p>You can then make futher connections to the database using this <code class="docutils literal notranslate"><span class="pre">dbclient</span></code> variable.  Many <code class="docutils literal notranslate"><span class="pre">snappl</span></code> functions that connect to the database take an optional <code class="docutils literal notranslate"><span class="pre">dbclient</span></code> parameter, to which you can pass this.  By default, most of them will, in the background, just use the first one that was created with the first call to <code class="docutils literal notranslate"><span class="pre">SNPITDBClient.get()</span></code>.   (See the docstring for <code class="docutils literal notranslate"><span class="pre">SNPITDBClient.get</span></code> if you are morbidly curious.)</p>
</section>
<section id="variables-arguments-for-ids-and-provenances">
<span id="recipe-command-line-args"></span><h4><a class="toc-backref" href="#id11" role="doc-backlink">Variables/Arguments for IDs and Provenances</a><a class="headerlink" href="#variables-arguments-for-ids-and-provenances" title="Link to this heading">¶</a></h4>
<p>Below, you will be told you need to know a number of object ids and/or provenance-related values.  These will generally be provided by orchestration.  You should make them things that can be passed on the command line.  I recommend using the following command-line arguments — choose the ones that you need (they are all string values):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">diaobject</span><span class="o">-</span><span class="nb">id</span>
<span class="o">--</span><span class="n">diaobject</span><span class="o">-</span><span class="n">provenance</span><span class="o">-</span><span class="n">tag</span>
<span class="o">--</span><span class="n">diaobject</span><span class="o">-</span><span class="n">process</span>
<span class="o">--</span><span class="n">diaobject</span><span class="o">-</span><span class="n">position</span><span class="o">-</span><span class="n">provenance</span><span class="o">-</span><span class="n">tag</span>
<span class="o">--</span><span class="n">diaobject</span><span class="o">-</span><span class="n">position</span><span class="o">-</span><span class="n">process</span>
<span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="nb">id</span>
<span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">provenance</span><span class="o">-</span><span class="n">tag</span>
<span class="o">--</span><span class="n">image</span><span class="o">-</span><span class="n">process</span>
<span class="o">--</span><span class="n">segmap</span><span class="o">-</span><span class="n">provenance</span><span class="o">-</span><span class="n">tag</span>
<span class="o">--</span><span class="n">segmap</span><span class="o">-</span><span class="n">process</span>
<span class="o">--</span><span class="n">ltcv</span><span class="o">-</span><span class="n">provenance</span><span class="o">-</span><span class="n">tag</span>
<span class="o">--</span><span class="n">ltcv</span><span class="o">-</span><span class="n">process</span>
<span class="o">--</span><span class="n">spec1d</span><span class="o">-</span><span class="n">provenance</span><span class="o">-</span><span class="n">tag</span>
<span class="o">--</span><span class="n">spec1d</span><span class="o">-</span><span class="n">process</span>
</pre></div>
</div>
<p>If you just plan to call functions from python, then you can make the things you need keyword arguments.  I recommend using the same names as above, only replacing the dashes with underscores (and removing the two dashes at the beginning).  The examples below all assume that the variables have these names.</p>
<p>For a list of provenance tags we will be using during the November 2025 run, see <a class="reference internal" href="#nov2025-provtags"><span class="std std-ref">Provenance Tags We Will Use In November 2025</span></a>.</p>
</section>
<section id="finding-a-diaobject">
<span id="recipe-find-diaobject"></span><h4><a class="toc-backref" href="#id12" role="doc-backlink">Finding a DiaObject</a><a class="headerlink" href="#finding-a-diaobject" title="Link to this heading">¶</a></h4>
<p>You need to know <em>either</em> the <code class="docutils literal notranslate"><span class="pre">diaobjectd_id</span></code> of the object (which you will generally be given), or you need to know the <code class="docutils literal notranslate"><span class="pre">diaobject_provenance_tag</span></code> and <code class="docutils literal notranslate"><span class="pre">diaobject_process</span></code>, and you must have enough search criteria to find the object.  If you’re doing the latter, read the docstring on <code class="docutils literal notranslate"><span class="pre">snappl.diaobject.DiaObject.find_objects</span></code>.  For the former:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.diaobject</span><span class="w"> </span><span class="kn">import</span> <span class="n">DiaObject</span>

<span class="n">diaobject</span> <span class="o">=</span> <span class="n">DiaObject</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span> <span class="n">diaobject_id</span><span class="o">=</span><span class="n">diaobject_id</span> <span class="p">)</span>
</pre></div>
</div>
<p>The returned <code class="docutils literal notranslate"><span class="pre">DiaObject</span></code> object has, among other things, properties <code class="docutils literal notranslate"><span class="pre">.id</span></code>, <code class="docutils literal notranslate"><span class="pre">.ra</span></code> and <code class="docutils literal notranslate"><span class="pre">.dec</span></code>.</p>
</section>
<section id="getting-an-updated-diaobject-position">
<span id="recipe-diaobject-position"></span><h4><a class="toc-backref" href="#id13" role="doc-backlink">Getting an updated diaobject position</a><a class="headerlink" href="#getting-an-updated-diaobject-position" title="Link to this heading">¶</a></h4>
<p>You need the <code class="docutils literal notranslate"><span class="pre">diaobject_position_provenance_tag</span></code> and <code class="docutils literal notranslate"><span class="pre">diaobject_position_process</span></code>.</p>
<p>Do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">diaobj_pos</span> <span class="o">=</span> <span class="n">diaobject</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span> <span class="n">provenance_tag</span><span class="o">=</span><span class="n">diaobject_position_provenance_tag</span><span class="p">,</span>
                                     <span class="n">process</span><span class="o">=</span><span class="n">diaobject_position_process</span> <span class="p">)</span>
</pre></div>
</div>
<p>You get back a dictionary that has a number of keys including <code class="docutils literal notranslate"><span class="pre">ra</span></code> and <code class="docutils literal notranslate"><span class="pre">dec</span></code>.</p>
</section>
<section id="getting-a-specific-image">
<h4><a class="toc-backref" href="#id14" role="doc-backlink">Getting a Specific Image</a><a class="headerlink" href="#getting-a-specific-image" title="Link to this heading">¶</a></h4>
<p>Orchestration has given you a <code class="docutils literal notranslate"><span class="pre">image_id</span></code> that you are supposed to do something with.  E.g.,, you are running sidecar, and you’re supposed to subtract and search this image.</p>
<blockquote>
<div><p>from snappl.image import Image</p>
<p>image = Image.get_image( image_id )</p>
</div></blockquote>
<p>You will get back an <code class="docutils literal notranslate"><span class="pre">Image</span></code> object (really, an object of a class that is a subclass of <code class="docutils literal notranslate"><span class="pre">Image</span></code>).  It has a number of properties.  Most important are <code class="docutils literal notranslate"><span class="pre">.data</span></code>, <code class="docutils literal notranslate"><span class="pre">.noise</span></code>, and <code class="docutils literal notranslate"><span class="pre">.flags</span></code>, which hold 2d numpy arrays.  There is also a <code class="docutils literal notranslate"><span class="pre">.get_fits_header()</span></code> method that currently works, <strong>but be careful using this as this method will not work in the future when we’re using ASDF files</strong>.  See the docstrings in <code class="docutils literal notranslate"><span class="pre">snappl.image.Image</span></code> for more details.  Some of the stuff you might want is available directly as properties of and <code class="docutils literal notranslate"><span class="pre">Image</span></code> object.</p>
</section>
<section id="finding-images">
<h4><a class="toc-backref" href="#id15" role="doc-backlink">Finding Images</a><a class="headerlink" href="#finding-images" title="Link to this heading">¶</a></h4>
<p>You need to know the <code class="docutils literal notranslate"><span class="pre">image_provenance_tag</span></code> and <code class="docutils literal notranslate"><span class="pre">image_process</span></code>.</p>
<p>See the docstring on <code class="docutils literal notranslate"><span class="pre">snappl.imagecollection.ImageCollection.find_images</span></code> if you want to do more than what’s below.</p>
<section id="finding-all-images-in-a-given-band-that-include-a-ra-and-dec">
<h5><a class="toc-backref" href="#id16" role="doc-backlink">Finding all images in a given band that include a ra and dec</a><a class="headerlink" href="#finding-all-images-in-a-given-band-that-include-a-ra-and-dec" title="Link to this heading">¶</a></h5>
<p>Do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.image</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="n">images</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">find_images</span><span class="p">(</span> <span class="n">provenance_tag</span><span class="o">=</span><span class="n">image_provenacne_tag</span><span class="p">,</span> <span class="n">process</span><span class="o">=</span><span class="n">image_process</span><span class="p">,</span>
                            <span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span> <span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">band=band</span></code> is optional but often useful.  (If you don’t specify it, you will get back images from all bands.) You will get back a list of <code class="docutils literal notranslate"><span class="pre">Image</span></code> objects, which have a number of properties (some of which may be <code class="docutils literal notranslate"><span class="pre">None</span></code> if they are unknown):</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code> : the data array, in ADU, a 2d numpy array</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">noise</span></code> : the ADU uncertainty on the data, a 2d numpy array</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flags</span></code> : pixel flags, a 2d numpy array of ints [we are still working on definining these]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">width</span></code> : int, the width of the image in pixels; horizontal as viewed on ds9; corresponds to data.shape[1]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">height</span></code> : int, the height of the image in pixels; vertical as viewed on ds9; corresponds to data.shape[0]</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">image_shape</span></code> : tuple of ints, (height, width)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pointing</span></code> : int or str, the pointing; <strong>warning</strong> this property name will change when we know more</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sca</span></code> : int, the chip of the image</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ra</span></code> : float, the nominal center of the image in decimal degrees (usu. from the header)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dec</span></code> : float, the nominal center of the image in decimal degrees (usu. from the header)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">coord_center</span></code> : tuple of (ra, dec) [I THINK], calcualted from the image WCS</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ra_corner_00</span></code> : float, decimal degrees, the RA of pixel (0, 0)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ra_corner_01</span></code> : float, decimal degrees, the RA of pixel (0, height-1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ra_corner_10</span></code> : float, decimal degrees, the RA of pixel (width-1, 0)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ra_corner_11</span></code> : float, decimal degrees, the RA of pixel (width-1, height-1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dec_corner_00</span></code> : float, decimal degrees, the Dec of pixel (0, 0)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dec_corner_01</span></code> : float, decimal degrees, the Dec of pixel (0, height-1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dec_corner_10</span></code> : float, decimal degrees, the Dec of pixel (width-1, 0)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dec_corner_11</span></code> : float, decimal degrees, the Dec of pixel (width-1, height-1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">band</span></code> : str, the filter/band/whatever you call it for this image</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mjd</span></code> : float, mjd (days) when the image exposure started</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">position_angle</span></code> : float, position angle in degrees north of east (CHECK THIS)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">exptime</span></code> float, exposure time in seconds</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sky_level</span></code> float; an estimate of the sky level (in ADU) if known, None otherwise</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">zeropoint</span></code> : float; convert ADU to AB magnitudes with <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">=</span> <span class="pre">-2.5*log10(adu)</span> <span class="pre">+</span> <span class="pre">zeropoint</span></code></p></li>
</ul>
</div></blockquote>
<p><strong>Warning</strong>: because of how numpy arrays are indexed, if you want to get the flux value in pixel <code class="docutils literal notranslate"><span class="pre">(ix,</span> <span class="pre">iy)</span></code>, you would look at <code class="docutils literal notranslate"><span class="pre">.data[iy,</span> <span class="pre">ix]</span></code>.</p>
<p>There is also a <code class="docutils literal notranslate"><span class="pre">.get_fits_header()</span></code> method that currently works, <strong>but be careful using this as this method will not work in the future when we’re using ASDF files</strong>.  See the docstrings in <code class="docutils literal notranslate"><span class="pre">snappl.image.Image</span></code> for more details.</p>
</section>
</section>
<section id="finding-segmentation-maps">
<h4><a class="toc-backref" href="#id17" role="doc-backlink">Finding Segmentation Maps</a><a class="headerlink" href="#finding-segmentation-maps" title="Link to this heading">¶</a></h4>
<p>You need to know the <code class="docutils literal notranslate"><span class="pre">segmap_provenance_tag</span></code> and the <code class="docutils literal notranslate"><span class="pre">segmap_process</span></code>.</p>
<p>See the docstring on <code class="docutils literal notranslate"><span class="pre">snappl.segmap.SegmentationMap.find_segmaps</span></code> for more information on searches you can do beyond what’s below.</p>
<section id="finding-all-segmaps-that-include-a-ra-and-dec">
<h5><a class="toc-backref" href="#id18" role="doc-backlink">Finding all segmaps that include a ra and dec</a><a class="headerlink" href="#finding-all-segmaps-that-include-a-ra-and-dec" title="Link to this heading">¶</a></h5>
<p>Do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.segmap</span><span class="w"> </span><span class="kn">import</span> <span class="n">SegmentationMap</span>

<span class="n">segmaps</span> <span class="o">=</span> <span class="n">SegmentationMap</span><span class="o">.</span><span class="n">find_segmaps</span><span class="p">(</span> <span class="n">provenance_tag</span><span class="o">=</span><span class="n">segmap_provenance_tag</span><span class="p">,</span>
                                        <span class="n">process</span><span class="o">=</span><span class="n">segmap_process</span><span class="p">,</span>
                                        <span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span> <span class="p">)</span>
</pre></div>
</div>
<p>You get back a list of <code class="docutils literal notranslate"><span class="pre">SegmentationMap</span></code> objects.  These have a number of properties, most import of which is <code class="docutils literal notranslate"><span class="pre">image</span></code>, which holds an <code class="docutils literal notranslate"><span class="pre">Image</span></code> object.  You can get the image data for the segmentation map for the first element of the list with <code class="docutils literal notranslate"><span class="pre">segmaps[0].image.data</span></code> (a 2d numpy array).</p>
</section>
</section>
<section id="saving-a-new-diaobject">
<h4><a class="toc-backref" href="#id19" role="doc-backlink">Saving a new DiaObject</a><a class="headerlink" href="#saving-a-new-diaobject" title="Link to this heading">¶</a></h4>
<p>You are running sidecar and you’ve found a new diaobject you want to save.  You need a <code class="docutils literal notranslate"><span class="pre">process</span></code> (we shall assume <code class="docutils literal notranslate"><span class="pre">process='sidecar'</span></code> here), the <code class="docutils literal notranslate"><span class="pre">major</span></code> and <code class="docutils literal notranslate"><span class="pre">minor</span></code> version of your code, and the <code class="docutils literal notranslate"><span class="pre">params</span></code> that define how the code runs.  The latter is just a dictionary; you can build it yourself, but see <a class="reference internal" href="#nov2025-making-prov"><span class="std std-ref">Making Provenances</span></a> below.  Finally, assume that <code class="docutils literal notranslate"><span class="pre">images</span></code> is an list that has the <code class="docutils literal notranslate"><span class="pre">snappl.image.Image</span></code> objects of the images that you’ve used; replace <code class="docutils literal notranslate"><span class="pre">images[0]</span></code> below with wherever you have your <code class="docutils literal notranslate"><span class="pre">Image</span></code> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.provenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">Provenance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.diaobject</span><span class="w"> </span><span class="kn">import</span> <span class="n">DiaObject</span>

<span class="n">imageprov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">provenance_id</span> <span class="p">)</span>
<span class="n">prov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="p">(</span> <span class="n">process</span><span class="o">=</span><span class="s1">&#39;sidecar&#39;</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                   <span class="n">upstreams</span><span class="o">=</span><span class="p">[</span> <span class="n">imageprov</span> <span class="p">]</span> <span class="p">)</span>
<span class="c1"># You only have to do this next line once for a given provenance;</span>
<span class="c1">#   once the provenance is in the database, you never need to save it again.</span>
<span class="n">prov</span><span class="o">.</span><span class="n">save_to_db</span><span class="p">(</span> <span class="n">tag</span><span class="o">=</span><span class="n">diaobject_provenance_tag</span> <span class="p">)</span>   <span class="c1"># See note below</span>

<span class="n">diaobj</span> <span class="o">=</span> <span class="n">DiaObject</span><span class="p">(</span> <span class="n">provenance_id</span><span class="o">=</span><span class="n">prov</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">optional</span><span class="p">,</span> <span class="n">mjd_discovery</span><span class="o">=</span><span class="n">mjd</span> <span class="p">)</span>
<span class="n">diaobj</span><span class="o">.</span><span class="n">save_object</span><span class="p">()</span>
</pre></div>
</div>
<p>This will save the object to the database.  You can then look at <code class="docutils literal notranslate"><span class="pre">diaobj.id</span></code> to see what UUID it was assigned.  You do not need to give it a <code class="docutils literal notranslate"><span class="pre">name</span></code>, but you can if you want to.  (The database uses the <code class="docutils literal notranslate"><span class="pre">id</span></code> as the unique identifier.)  <code class="docutils literal notranslate"><span class="pre">mjd_discovery</span></code> should be the MJD of the science image that the object was found on.</p>
</section>
<section id="finding-and-reading-lightcurves">
<h4><a class="toc-backref" href="#id20" role="doc-backlink">Finding and reading lightcurves</a><a class="headerlink" href="#finding-and-reading-lightcurves" title="Link to this heading">¶</a></h4>
<p>You need to know the <code class="docutils literal notranslate"><span class="pre">ltcv_provenance_tag</span></code> and <code class="docutils literal notranslate"><span class="pre">ltcv_process</span></code>, and the <code class="docutils literal notranslate"><span class="pre">diaobject_id</span></code> of the object for which you want to get lightcurves:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.lightcurve</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lightcurve</span>

<span class="n">ltcvs</span> <span class="o">=</span> <span class="n">Lightcurve</span><span class="o">.</span><span class="n">find_lightcurves</span><span class="p">(</span> <span class="n">provenance_tag</span><span class="o">=</span><span class="n">ltcv_provenance_tag</span><span class="p">,</span>
                                     <span class="n">process</span><span class="o">=</span><span class="n">ltcv_process</span><span class="p">,</span>
                                     <span class="n">diaobject</span><span class="o">=</span><span class="n">diaobject_id</span><span class="p">,</span>
                                     <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span>         <span class="c1"># optional</span>
                                   <span class="p">)</span>
</pre></div>
</div>
<p>You will get back a list of <code class="docutils literal notranslate"><span class="pre">Lightcurve</span></code> objects.  You can find the actual lightcurve data of the first lightcurve from the list with <code class="docutils literal notranslate"><span class="pre">ltcvs[0].lightcurve</span></code>.  This is an astropy QTable.  You can read the metadata from <code class="docutils literal notranslate"><span class="pre">ltcvs[0].lightcurve.meta</span></code>.</p>
<p><strong>Coming soon</strong>: a way to read a combined lightcurve that has all of the bands mixed together.  (Not implemented yet.)</p>
</section>
<section id="saving-lightcurves">
<h4><a class="toc-backref" href="#id21" role="doc-backlink">Saving lightcurves</a><a class="headerlink" href="#saving-lightcurves" title="Link to this heading">¶</a></h4>
<p>You need to make sure you’ve created a dictionary with <a class="reference external" href="https://github.com/Roman-Supernova-PIT/Roman-Supernova-PIT/wiki/lightcurve">all the necessary metadata</a>.  Also make sure you’ve created a data table with the necessary columns; this can be an astropy Table, a pandas DataFrame, or a dict of lists.  We shall call these two things <code class="docutils literal notranslate"><span class="pre">meta</span></code> and <code class="docutils literal notranslate"><span class="pre">data</span></code>.</p>
<p>Assume that you’ve made the lightcurve for object <code class="docutils literal notranslate"><span class="pre">diaobject</span></code> (a <code class="docutils literal notranslate"><span class="pre">DiaObject</span></code> object), and that you have a list of your images in <code class="docutils literal notranslate"><span class="pre">images</span></code>.  Adjust below for the variables where you really have things.  Finally, if you used an updated <a class="reference internal" href="#recipe-diaobject-position"><span class="std std-ref">DiaObject position</span></a>, make sure you have set the <code class="docutils literal notranslate"><span class="pre">ra</span></code> and <code class="docutils literal notranslate"><span class="pre">dec</span></code> in <code class="docutils literal notranslate"><span class="pre">meta</span></code> from that.</p>
<p>Finally, you will need to know the <code class="docutils literal notranslate"><span class="pre">ltcv_provenance_tag</span></code> we’re using.</p>
<p>Below, <code class="docutils literal notranslate"><span class="pre">process</span></code> is probably either <code class="docutils literal notranslate"><span class="pre">campari</span></code> or <code class="docutils literal notranslate"><span class="pre">phrosty</span></code>.  <code class="docutils literal notranslate"><span class="pre">major</span></code> and <code class="docutils literal notranslate"><span class="pre">minor</span></code> are the major and minor parts of the version, which you should parse from <code class="docutils literal notranslate"><span class="pre">campari.__version__</span></code> or <code class="docutils literal notranslate"><span class="pre">phrosty.__version__</span></code>.  <code class="docutils literal notranslate"><span class="pre">params</span></code> are the parameters as described below in <a class="reference internal" href="#nov2025-making-prov"><span class="std std-ref">Making Provenances</span></a>.</p>
<p>Do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.provenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">Provenance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.lightcurve</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lightcurve</span>

<span class="n">imgprov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">provenance_id</span> <span class="p">)</span>
<span class="n">objprov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">diaobject</span><span class="o">.</span><span class="n">provenance_id</span> <span class="p">)</span>
<span class="n">objposprov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">diaobj_pos</span><span class="p">[</span><span class="s1">&#39;provenance_id&#39;</span><span class="p">]</span> <span class="p">)</span>

<span class="n">ltcvprov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="p">(</span> <span class="n">process</span><span class="o">=</span><span class="n">process</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                       <span class="n">upstreams</span><span class="o">=</span><span class="p">[</span><span class="n">imgprov</span><span class="p">,</span> <span class="n">objprov</span><span class="p">,</span> <span class="n">objposprov</span><span class="p">]</span> <span class="p">)</span>
<span class="c1"># The next line only needs to be run once.  Once you&#39;ve saved it to the database,</span>
<span class="c1">#   you never need to do this again.</span>
<span class="n">ltcvprov</span><span class="o">.</span><span class="n">save_to_db</span><span class="p">(</span> <span class="n">tag</span><span class="o">=</span><span class="n">ltcv_provenance_tag</span> <span class="p">)</span>

<span class="n">meta</span><span class="p">[</span><span class="s1">&#39;provenance_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ltcvprov</span><span class="o">.</span><span class="n">id</span>
<span class="n">meta</span><span class="p">[</span><span class="s1">&#39;diaobject_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diaobject</span><span class="o">.</span><span class="n">id</span>
<span class="n">meta</span><span class="p">[</span><span class="s1">&#39;diaobject_position_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diaobj_pos</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;ra_err&#39;</span><span class="p">,</span> <span class="s1">&#39;dec_err&#39;</span><span class="p">,</span> <span class="s1">&#39;ra_dec_covar&#39;</span> <span class="p">]:</span>
    <span class="n">meta</span><span class="p">[</span><span class="n">att</span><span class="p">]</span> <span class="o">=</span> <span class="n">diaobj_pos</span><span class="p">[</span><span class="n">att</span><span class="p">]</span>

<span class="n">ltcv</span> <span class="o">=</span> <span class="n">Lightcurve</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span> <span class="p">)</span>
<span class="n">ltcv</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
<span class="n">ltcv</span><span class="o">.</span><span class="n">save_to_db</span><span class="p">()</span>
</pre></div>
</div>
<p>You can look at <code class="docutils literal notranslate"><span class="pre">ltcv.id</span></code> to see the <code class="docutils literal notranslate"><span class="pre">UUID</span></code> of the lightcurve you saved, in case you are curious.</p>
<p>If you used the <code class="docutils literal notranslate"><span class="pre">ra</span></code> and <code class="docutils literal notranslate"><span class="pre">dec</span></code> that was in <code class="docutils literal notranslate"><span class="pre">DiaObject</span></code>, then <code class="docutils literal notranslate"><span class="pre">meta['diaobject_position_id']</span></code> should be <code class="docutils literal notranslate"><span class="pre">None</span></code>.  Skip everything else above that refers to <code class="docutils literal notranslate"><span class="pre">diaobj_pos</span></code>.</p>
</section>
<section id="finding-and-reading-1d-spectra">
<h4><a class="toc-backref" href="#id22" role="doc-backlink">Finding and reading 1d Spectra</a><a class="headerlink" href="#finding-and-reading-1d-spectra" title="Link to this heading">¶</a></h4>
<p>Right now we only have 1-d transient spectra, defined by <a class="reference external" href="https://github.com/Roman-Supernova-PIT/Roman-Supernova-PIT/wiki/spectrum_1d">the schema here</a>.</p>
<p>If you already know the ID of the spectrum you want, you can just do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.spectrum1d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spectrum1d</span>

<span class="n">spec</span> <span class="o">=</span> <span class="n">Spectrum1d</span><span class="o">.</span><span class="n">get_spectrum1d</span><span class="p">(</span> <span class="n">spectrum1d_id</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="simple">
<dt>That will return a <code class="docutils literal notranslate"><span class="pre">Spectrum1d</span></code> object.  See its docstring for more information.  The most important property is probably <code class="docutils literal notranslate"><span class="pre">combined_data</span></code>, which has dictionary with four elements; each value of the dictionary is a numpy array of the same length:</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lamb</span></code> : the wavelength (in Å)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flam</span></code> : the flux (in what erg/s/cm²/Å)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">func</span></code> : the uncertainty on <code class="docutils literal notranslate"><span class="pre">flam</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">count</span></code> : an integer, the number of individual image spectra that contributed to this data point.</p></li>
</ul>
</dd>
</dl>
<p>The <code class="docutils literal notranslate"><span class="pre">data_dict</span></code> property has the full dictionary of data defined in the 1d spectrum schema.</p>
<p>You can find a spectra for a given object with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.spectrum1d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spectrum1d</span>

<span class="n">specs</span> <span class="o">=</span> <span class="n">Spectrum1d</span><span class="o">.</span><span class="n">find_spectra</span><span class="p">(</span> <span class="n">provenance_tag</span><span class="o">=</span><span class="n">spec1d_provenance_tag</span><span class="p">,</span>
                                 <span class="n">process</span><span class="o">=</span><span class="n">spec1d_process</span><span class="p">,</span>
                                 <span class="n">diaobject_id</span><span class="o">=</span><span class="n">diaobject_id</span><span class="p">,</span>
                                 <span class="n">mjd_start_min</span><span class="o">=</span><span class="n">mjd0</span><span class="p">,</span>       <span class="c1"># optional</span>
                                 <span class="n">mjd_end_max</span><span class="o">=</span><span class="n">mjd1</span>        <span class="c1"># optional</span>
                               <span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">mjd...</span></code> parmaeters are optional; include these if you want to provide a time window into which all the images that went into the spectra fit.  See the <code class="docutils literal notranslate"><span class="pre">find_spectra</span></code> docstring for more optional parameters you can supply for the search.  You will get back a list of <code class="docutils literal notranslate"><span class="pre">Spectrum1d</span></code> objects.</p>
</section>
<section id="saving-1d-spectra">
<h4><a class="toc-backref" href="#id23" role="doc-backlink">Saving 1d Spectra</a><a class="headerlink" href="#saving-1d-spectra" title="Link to this heading">¶</a></h4>
<p>You need to have the <code class="docutils literal notranslate"><span class="pre">diaobject</span></code> (a <code class="docutils literal notranslate"><span class="pre">DiaObject</span></code> object) for which you made the spectrum, potentially a <code class="docutils literal notranslate"><span class="pre">diaobj_pos</span></code>, an improved position for the object, and <code class="docutils literal notranslate"><span class="pre">images</span></code>, a list of <code class="docutils literal notranslate"><span class="pre">Image</span></code> object that held the dispersed images from which you are making the spectrum.  You need to know the <code class="docutils literal notranslate"><span class="pre">spec1d_provenance_tag</span></code>.</p>
<p>You need to know the <code class="docutils literal notranslate"><span class="pre">process</span></code> (which is probably just the name of your code), and the <code class="docutils literal notranslate"><span class="pre">major</span></code> and <code class="docutils literal notranslate"><span class="pre">minor</span></code> versions of your code.  Finally, you need to know the <code class="docutils literal notranslate"><span class="pre">params</span></code> that define how your code runs.   The latter is just a dictionary; you can build it yourself, but see <a class="reference internal" href="#nov2025-making-prov"><span class="std std-ref">Making Provenances</span></a> below.</p>
<p>You build a data structure that is described on <a class="reference external" href="https://github.com/Roman-Supernova-PIT/Roman-Supernova-PIT/wiki/spectrum_1d">the wiki</a>; call that <code class="docutils literal notranslate"><span class="pre">spec_struct</span></code>.  Note that if you pass all of <code class="docutils literal notranslate"><span class="pre">provenance</span></code>, <code class="docutils literal notranslate"><span class="pre">diaobject</span></code>, and <code class="docutils literal notranslate"><span class="pre">diaobject_position_id</span></code> to the <code class="docutils literal notranslate"><span class="pre">Spectrum1d</span></code> constructor, you do not necessarily need to have all those IDs in the <code class="docutils literal notranslate"><span class="pre">spec_struct</span></code> ahead of time; the constructor will fill out what is necessary.  If you do both pass them and put them in the <code class="docutils literal notranslate"><span class="pre">spec_struct</span></code>, they must be consistent.  You do <em>not</em> need to (and should not) set <code class="docutils literal notranslate"><span class="pre">meta['id']</span></code> or <code class="docutils literal notranslate"><span class="pre">meta['filepath']</span></code> yourself.  <code class="docutils literal notranslate"><span class="pre">id</span></code> will be generated when you construct the <code class="docutils literal notranslate"><span class="pre">Spectrum1d</span></code> object, and <code class="docutils literal notranslate"><span class="pre">filepath</span></code> will be set automatically when you save the spectrum.</p>
<p>Do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.provenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">Provenance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.spec1d</span><span class="w"> </span><span class="kn">import</span> <span class="n">Spectrum1d</span>

<span class="n">diaobj_prov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">diaobject</span><span class="o">.</span><span class="n">provenance_id</span> <span class="p">)</span>
<span class="n">imageprov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">provenance_id</span> <span class="p">)</span>
<span class="n">diaobj_pos_prov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">diaobj_pos</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="p">)</span>

<span class="n">spec1d_prov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="p">(</span> <span class="n">process</span><span class="o">=</span><span class="n">process</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                          <span class="n">upstreams</span><span class="o">=</span><span class="p">[</span> <span class="n">diaobj_prov</span><span class="p">,</span> <span class="n">imageprov</span><span class="p">,</span> <span class="n">diaobj_pos_prov</span> <span class="p">]</span> <span class="p">)</span>
<span class="c1"># The next line only needs to be run once.  Once</span>
<span class="c1">#   you have saved a Provenance to the database you</span>
<span class="c1">#   never need to save it again</span>
<span class="n">spec1d_prov</span><span class="o">.</span><span class="n">save_to_db</span><span class="p">(</span> <span class="n">tag</span><span class="o">=</span><span class="n">spec1d_provenance_tag</span> <span class="p">)</span>

<span class="c1"># Make sure that all the mandatory metadata is there.  In particular, it is necessary</span>
<span class="c1">#   for each spec_struct[&#39;individual][n][&#39;meta&#39;][&#39;image_id&#39;] to be set (where n is an</span>
<span class="c1">#   integer).  You could do this with:</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="p">):</span>
    <span class="n">spec_struct</span><span class="p">[</span><span class="s1">&#39;individual&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;meta&#39;</span><span class="p">][</span><span class="s1">&#39;image_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>

<span class="n">spec1d</span> <span class="o">=</span> <span class="n">Spectrum1d</span><span class="p">(</span> <span class="n">spec_struct</span> <span class="p">)</span>
<span class="n">spec1d</span><span class="o">.</span><span class="n">save_to_db</span><span class="p">(</span> <span class="n">write</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
</pre></div>
</div>
<p>Note that when you create a <code class="docutils literal notranslate"><span class="pre">Spectrum1d</span></code>, it will keep a <em>copy</em> of the <code class="docutils literal notranslate"><span class="pre">spec_struct</span></code> object you passed in its <code class="docutils literal notranslate"><span class="pre">spec_struct</span></code> property.  It will also modify this object, adding the <code class="docutils literal notranslate"><span class="pre">id</span></code> and <code class="docutils literal notranslate"><span class="pre">filepath</span></code> attributes, as well other things based on what you pass to the constructor.  You can always get back at the internally stored structure with the <code class="docutils literal notranslate"><span class="pre">data_dict</span></code> property of the <code class="docutils literal notranslate"><span class="pre">Spectrum1d</span></code> object.</p>
<hr class="docutils" />
</section>
</section>
<section id="choose-a-working-environment">
<span id="nov2025-working-env"></span><h3><a class="toc-backref" href="#id24" role="doc-backlink">Choose a working environment</a><a class="headerlink" href="#choose-a-working-environment" title="Link to this heading">¶</a></h3>
<p>Whatever it is, you will need to <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">roman-snpit-snappl</span></code>.  <em>This package is under heavy development, so you will want to update your install often</em>.  This provides the <code class="docutils literal notranslate"><span class="pre">snappl</span></code> modules that you are currently reading the documentation for.</p>
<p><strong>We strongly recommend you think ahead towards developing your code to run in a container.  The SNPIT will probably eventually need to run everything it does in containers.</strong>  On your desktop or laptop, you can use Docker.  On NERSC, you can use <code class="docutils literal notranslate"><span class="pre">podman-hpc</span></code>.  On many other HPC clusters, you can use Singularity.</p>
<p>The SN PIT provides a containerized environment which includes the latest version of snappl at <a class="reference external" href="https://github.com/Roman-Supernova-PIT/environment">https://github.com/Roman-Supernova-PIT/environment</a> .  You can pull the docker image for this environment from one of:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">registry.nersc.gov/m4385/rknop/roman-snpit-env:cpu</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">registry.nersc.gov/m4385/rknop/roman-snpit-env:cpu-dev</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">registry.nersc.gov/m4385/rknop/roman-snpit-env:cuda</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">registry.nersc.gov/m4385/rknop/roman-snpit-env:cuda-dev</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rknop/roman-snpit-env:cpu</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rknop/roman-snpit-env:cpu-dev</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rknop/roman-snpit-env:cuda</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rknop/roman-snpit-env:cuda-dev</span></code></p></li>
</ul>
</div></blockquote>
<p>We recommend you use the <code class="docutils literal notranslate"><span class="pre">cpu</span></code> version, unless you need CUDA, in which case try the <code class="docutils literal notranslate"><span class="pre">cuda</span></code> version, but you may need the <code class="docutils literal notranslate"><span class="pre">cuda-dev</span></code> version (which is terribly bloated).</p>
<p><strong>WARNING:</strong> The snpit docker environment does not currently work on ARM architecture machines (because of issues with Galsim and fftw).  This means that if you’re on a Mac, you’re SOL.  If you’re on a Linux machine, do <code class="docutils literal notranslate"><span class="pre">uname</span> <span class="pre">-a</span></code> and look towards the end of the output to see if you’re on <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> or ARM.  We hope to resolve this eventually.  For now, as much as possible run on <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> machines.  (However, reports are that <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">instasll</span> <span class="pre">roman-snpit-snappl</span></code> <em>does</em> work on ARM Macs, so the issue may just be we need to figure out how to get the docker images to build for ARM.)</p>
<p>You can, of course, create your own containerized environment for your code to run in, but you will need to support it, and eventually you will need to deliver it for the PIT to run in production.  For that reason, we strongly recommend you start trying to use the standard SNPIT environment.  Ideally, your code should be pip installable from PyPI, and eventually your code will be included in the environment just like <code class="docutils literal notranslate"><span class="pre">snappl</span></code> currently is.</p>
</section>
<section id="making-provenances">
<span id="nov2025-making-prov"></span><h3><a class="toc-backref" href="#id25" role="doc-backlink">Making Provenances</a><a class="headerlink" href="#making-provenances" title="Link to this heading">¶</a></h3>
<p>Before you save anything to the database, you need to make a <a class="reference internal" href="#provenance"><span class="std std-ref">Provenance</span></a> for it.  For example, consider the difference imaging lightcurve package <code class="docutils literal notranslate"><span class="pre">phrosty</span></code>.  It will need to have a diaobject (let’s assume it’s in the variable <code class="docutils literal notranslate"><span class="pre">obj</span></code>), and it will need to have a list of images (let’s assume they’re in the variable <code class="docutils literal notranslate"><span class="pre">images</span></code>; we’ll leave aside details of template vs. science images for now).  Let’s assume <code class="docutils literal notranslate"><span class="pre">phrosty</span></code> is using the <a class="reference internal" href="#config"><span class="std std-ref">Config</span></a> system in <code class="docutils literal notranslate"><span class="pre">snappl</span></code>, and has put all of its configuration under <code class="docutils literal notranslate"><span class="pre">photometry.phrosty</span></code>.  (There are details here you must be careful about; things like paths on your current system should <em>not</em> go under <code class="docutils literal notranslate"><span class="pre">photometry.phrosty</span></code>, but should go somewhere underneath <code class="docutils literal notranslate"><span class="pre">system.</span></code>.  The current object and list of images you’re working on should not be in the configuration, but should just be passed via command-line parameters.  The idea is that the configuration has all of, but only, the things that are the same for a large number of runs on a large number of input files which guarantee (as much as possible) the same output files.)</p>
<p>phrosty could then determine its own provenance with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.provenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">Provenance</span>

<span class="n">objprov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">obj</span><span class="o">.</span><span class="n">provenance_id</span> <span class="p">)</span>
<span class="n">improv</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">provenance_id</span> <span class="p">)</span>
<span class="n">phrostyprov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="p">(</span> <span class="n">process</span><span class="o">=</span><span class="s1">&#39;phrosty&#39;</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="n">MAJOR</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">MINOR</span><span class="p">,</span>
                          <span class="n">upstreams</span><span class="o">=</span><span class="p">[</span> <span class="n">objprov</span><span class="p">,</span> <span class="n">improv</span> <span class="p">],</span>
                          <span class="n">params</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">omitkeys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepkeys</span><span class="o">=</span><span class="p">[</span> <span class="s1">&#39;photometry.phrosty&#39;</span> <span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="#provenance"><span class="std std-ref">Provenance</span></a> below for more details about what all of this means.  Here, <code class="docutils literal notranslate"><span class="pre">MAJOR</span></code> and <code class="docutils literal notranslate"><span class="pre">MINOR</span></code> are the first two parts of the <a class="reference external" href="https://semver.org/">semantic version</a> of phrosty.</p>
<p>We recommend that phrosty put in its output files, somewhere, in addition to what’s obvious:</p>
<blockquote>
<div><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">provenance_id</span></code> for phrosty (obtained from <code class="docutils literal notranslate"><span class="pre">phrostyprov.id</span></code>).</p></li>
<li><p>The configuration parameters for phrosty (obtained from <code class="docutils literal notranslate"><span class="pre">phrostprov.params</span></code> — a dictionary).</p></li>
</ul>
</div></blockquote>
<p>(If you’re very anal, you may want to save a gigantic dictionary structure including everything from <code class="docutils literal notranslate"><span class="pre">phrostyprov</span></code> and everything from all of the upstream provenances, and the upstreams of the upstreams, etc.)</p>
<p><strong>NOTE</strong>: provenance can also store environment and environment version, but we don’t have that fully defined yet.</p>
<p>Before saving anything to the database, you will need to make sure that the provenance has been saved to the database.  If you are sure that you’ve saved this same Provenance before, you can skip this step, but at some point you will need to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">phrostyprov</span><span class="o">.</span><span class="n">save_to_db</span><span class="p">(</span> <span class="n">tag</span><span class="o">=</span><span class="n">PROVENANCE_TAG</span> <span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">PROVENANCE_TAG</span></code> is a string; see <a class="reference internal" href="#nov2025-provtags"><span class="std std-ref">Provenance Tags We Will Use In November 2025</span></a> below for a list of what we plan to use.</p>
</section>
<section id="provenance-tags-we-will-use-in-november-2025">
<span id="nov2025-provtags"></span><h3><a class="toc-backref" href="#id26" role="doc-backlink">Provenance Tags We Will Use In November 2025</a><a class="headerlink" href="#provenance-tags-we-will-use-in-november-2025" title="Link to this heading">¶</a></h3>
<p><strong>WARNING</strong>: View this list as preliminary.  It may all change at any moment.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>provenance_tag</p></th>
<th class="head"><p>process</p></th>
<th class="head"><p>for</p></th>
<th class="head"><p>produced by</p></th>
<th class="head"><p>notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ou2024_truth</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">load_ou2024_diaobject</span></code></p></td>
<td><p>diaobject</p></td>
<td><p>(primordial)</p></td>
<td><p>Truth-table
objects</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ou2204_truth</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">diaobject_position</span></code></p></td>
<td><p>diaobject_position</p></td>
<td><p>(primordial)</p></td>
<td><p>Truth-table
positions (1)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ou2024</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">load_ou2024_image</span></code></p></td>
<td><p>direct image</p></td>
<td><p>(primordial)</p></td>
<td><p>l2 images</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ou2024</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">load_ou2024_dispimages</span></code></p></td>
<td><p>prism image</p></td>
<td><p>(primordial)</p></td>
<td><p>l2 prism images</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nov2025</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">sidecar</span></code></p></td>
<td><p>diaobject</p></td>
<td><p>sidecar</p></td>
<td><p>objects found
by sidecar dia</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">nov2025</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">phrosty</span></code></p></td>
<td><p>lightcurve</p></td>
<td><p>phrosty</p></td>
<td><p>forced-phot
lightcurves
on sidecar objs</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nov2025_ou2024</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">phrosty</span></code></p></td>
<td><p>lightcurve</p></td>
<td><p>phrosty</p></td>
<td><p>forced-phot
lightcurves
on ou2024 objs</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">nov2025</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">phrosty_position</span></code></p></td>
<td><p>diaobject_position</p></td>
<td><p>phrosty</p></td>
<td><p>improved
positions of
sidecar objs</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nov2025</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">campari</span></code></p></td>
<td><p>lightcurve</p></td>
<td><p>campari</p></td>
<td><p>scene-modelling
lightcurve</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">nov2025</span></code></p></td>
<td><p>(something)</p></td>
<td><p>spectrum1d</p></td>
<td><p>(something)</p></td>
<td><p>spectra of
sidecar objs w/
phrosty poses</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">nov2025_ou2024</span></code></p></td>
<td><p>(something)</p></td>
<td><p>spectrum1d</p></td>
<td><p>(something)</p></td>
<td><p>spectra of
ou2024 truth
objs w/ truth
poses</p></td>
</tr>
</tbody>
</table>
<p><strong>(1)</strong> These positions will be identical to the positions in the <code class="docutils literal notranslate"><span class="pre">DiaObject</span></code> object for the <code class="docutils literal notranslate"><span class="pre">ou2024_truth</span></code> provenance tag.  However, they are still here so you can write the code to use the positions table.</p>
</section>
</section>
<section id="connecting-to-the-database">
<span id="id1"></span><h2><a class="toc-backref" href="#id27" role="doc-backlink">Connecting to the Database</a><a class="headerlink" href="#connecting-to-the-database" title="Link to this heading">¶</a></h2>
<p>To connect to the database, you need three things.  First, you have to know the url of the web API front-end to the database.  You must also have a username and a password for that web API.  (NOTE: the config system is likely to change in the future, so exactly how this works may change.)  If you’re using <a class="reference internal" href="#test-env"><span class="std std-ref">The Roman SNPIT Test Environment</span></a>, then the test fixture <code class="docutils literal notranslate"><span class="pre">dbclient</span></code> configures a user with username <code class="docutils literal notranslate"><span class="pre">test</span></code> and password <code class="docutils literal notranslate"><span class="pre">test_password</span></code>, and in that environment the url of the web API is <code class="docutils literal notranslate"><span class="pre">https://webserver:8080/</span></code>.</p>
<p>You configure all of these things by setting the <code class="docutils literal notranslate"><span class="pre">system.db.url</span></code>, <code class="docutils literal notranslate"><span class="pre">system.db.username</span></code>, and either <code class="docutils literal notranslate"><span class="pre">system.db.password</span></code> or <code class="docutils literal notranslate"><span class="pre">system.db.password_file</span></code> in the configuration yaml files.  (See <a class="reference internal" href="#config"><span class="std std-ref">Config</span></a> below.)  For example, see the default <a class="reference external" href="https://github.com/Roman-Supernova-PIT/environment/blob/main/snpit_system_config.yaml">snpit_system_config.yaml</a> in the Roman SNPIT environment.  <em>Do not save passwords to any git archive, and do not leave them sitting about in insecure places.</em>  Of course, having to type it all the time is a pain.  A reasonable compromise is to have a <code class="docutils literal notranslate"><span class="pre">secrets</span></code> directory under your home directory <strong>that is not world-readable</strong> (<code class="docutils literal notranslate"><span class="pre">chown</span> <span class="pre">700</span> <span class="pre">secrets</span></code>).  Then you can create files in there.  Put your password in a file, and set the location of that file in the <code class="docutils literal notranslate"><span class="pre">system.db.password_file</span></code> config.  (Make <code class="docutils literal notranslate"><span class="pre">system.db.password</span></code> to be <code class="docutils literal notranslate"><span class="pre">null</span></code> so the password file will be used.)  If you’re using a docker container, of course you’ll need to bind-mount your secrets directory.</p>
<p>Once you’ve configured these things, you should be able to connect to the database.  You can get a connection object with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.dbclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">SNPITDBClient</span>

<span class="n">dbclient</span> <span class="o">=</span> <span class="n">SNPITDBClient</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
<p>Thereafter, you can pass this <code class="docutils literal notranslate"><span class="pre">dbclient</span></code> as an optional argument to any <code class="docutils literal notranslate"><span class="pre">snappl</span></code> function that accesses the database.  (Lots of the examples below do not explicitly include this argument, but you could add it to them.)  Most of these functions will just use the first <code class="docutils literal notranslate"><span class="pre">dbclient</span></code> you created (which is cached in the background) if you don’t pass one, or create one themselves if one doesn’t already exists, so usually passing one isn’t necessary.</p>
</section>
<section id="config">
<span id="id2"></span><h2><a class="toc-backref" href="#id28" role="doc-backlink">Config</a><a class="headerlink" href="#config" title="Link to this heading">¶</a></h2>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">snappl</span></code> includes a config system whereby configuration files can be stored in yaml files.  It has the ability to include other yaml files, and to override any of the config values on the command line, if properly used.</p>
<section id="the-default-confg">
<h3><a class="toc-backref" href="#id29" role="doc-backlink">The Default Confg</a><a class="headerlink" href="#the-default-confg" title="Link to this heading">¶</a></h3>
<p>You can find an example/default config for the Roman SNPIT in two files in the <code class="xref py py-obj docutils literal notranslate"><span class="pre">environment</span></code> github repo:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://github.com/Roman-Supernova-PIT/environment/blob/main/default_snpit_config.yaml">default_snpit_config.yaml</a></p></li>
<li><p><a class="reference external" href="https://github.com/Roman-Supernova-PIT/environment/blob/main/snpit_system_config.yaml">snpit_system_config.yaml</a></p></li>
</ul>
</div></blockquote>
<p>Notice that the first one includes the second one.  In the standard Roman SNPIT docker image, these two files are present in the root directory (<code class="docutils literal notranslate"><span class="pre">/</span></code>).</p>
<p>Ideally, all config for every SNPIT application will be in this default config file, so we can all use the same config and be sure we know what we’re doing.  Of course, that’s far too cumbersome for development, so during development you will want to make your own config file with just the things you need in it.</p>
<p>By convention, everything underneath the <code class="docutils literal notranslate"><span class="pre">system</span></code> top level key are the things that you might have to change when moving from one cluster to another cluster, but that don’t change the behavior of the code.  This includes paths for where to find things, configurations as to where the database is, login credentials, and the like.  Everything that is _not_ under <code class="docutils literal notranslate"><span class="pre">system</span></code> should be things that define the behavior of your code.  These are the things that are the same every you run on different inputs.  It should _not_ include things like the specific images or diaobjects you’re currently working on.  Ideally, everything that’s _not_ in system, if it stays the same, will give the same outputs on the same inputs when run anywhere.</p>
</section>
<section id="using-config">
<h3><a class="toc-backref" href="#id30" role="doc-backlink">Using Config</a><a class="headerlink" href="#using-config" title="Link to this heading">¶</a></h3>
<p>To use config, you first have to set the environment variable <code class="docutils literal notranslate"><span class="pre">SNIPIT_CONFIG</span></code> to the location of the top-level config file.  If you’re using the default config and working in the roman snpit docker image, you can do this with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">SNPIT_CONFIG</span><span class="o">=/</span><span class="n">default_snpit_config</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>Then, in your code, to get access to the config, you can just run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>

<span class="o">...</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;system.paths.temp_dir` )</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Config.get()</span></code> gets you a config object.  Then, just call that object’s <code class="docutils literal notranslate"><span class="pre">value</span></code> method to get the actual config values.  Separate different levels of dictionaries in the config with periods, as in the example.  (Look at <code class="docutils literal notranslate"><span class="pre">default_snpit_config.yaml</span></code> to see how the config file corresponds to the value in the example above.)</p>
<p>There are more complicated uses of Config (including reading different, custom config files, modifying the config at runtime, understanding how the config files and all the possible modes of including other files are composed).  Read the docstring on <code class="docutils literal notranslate"><span class="pre">snappl.config.Config</span></code> for more information.</p>
<section id="overriding-parameters-on-the-command-line">
<h4><a class="toc-backref" href="#id31" role="doc-backlink">Overriding Parameters on the Command Line</a><a class="headerlink" href="#overriding-parameters-on-the-command-line" title="Link to this heading">¶</a></h4>
<p>At runtime, if you set things up properly, you can override some of the parameters from the config file with command-line arguments.  To accomplish this, you must be using python’s <code class="docutils literal notranslate"><span class="pre">argparse</span></code> package.  When you’re ready to parse your arguments, write the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">configparser</span> <span class="o">=</span> <span class="n">argarse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
<span class="n">configparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--config-file&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="p">(</span> <span class="s2">&quot;Location of the .yaml config file; defaults to the value of the &quot;</span>
                                  <span class="s2">&quot;SNPIT_CONFIG environment variable.&quot;</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">args</span><span class="p">,</span> <span class="n">leftovers</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">config_file</span><span class="p">,</span> <span class="n">setdefault</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;No default config defined yet; run Config.init(configfile)&#39;</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;Error, no configuration file defined.</span><span class="se">\n</span><span class="s2">&quot;</span>
                          <span class="s2">&quot;Either run &lt;your application name&gt; with -c &lt;configfile&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                          <span class="s2">&quot;or set the SNPIT_CONFIG environment variable.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="c1"># Put in the config_file argument, even though it will never be found, so it shows up in help</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--config-file&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Location of the .yaml config file&quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>After that, put all of the <code class="docutils literal notranslate"><span class="pre">parser.add_argument</span></code> lines that you need for the command-line arguments to your code.  Then, at the bottom, after you’re done with all of your <code class="docutils literal notranslate"><span class="pre">parser.add_argument</span></code> calls, put in the code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span><span class="o">.</span><span class="n">augment_argparse</span><span class="p">(</span> <span class="n">parser</span> <span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span> <span class="n">leftovers</span> <span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span> <span class="n">args</span> <span class="p">)</span>
</pre></div>
</div>
<p>At this point in your code, you can get access to the command line arguments you specified with the <code class="docutils literal notranslate"><span class="pre">args</span></code> variable as usual.  However, the running config (that you get with <code class="docutils literal notranslate"><span class="pre">Config.get()</span></code>) will _also_ have been updated with any changes made on the command line.</p>
<p>If you’ve set your code up like this, run it with <code class="docutils literal notranslate"><span class="pre">--help</span></code>.  You will see the help on the arguments you defined, but you will also see optional arguments for everything that is in the config file.</p>
<p>TODO : make it so you can only include some of the top-level keys from the config file in what gets overridden on the command line, to avoid things getting far too cluttered with irrelevant options.</p>
</section>
</section>
</section>
<section id="provenance">
<span id="id4"></span><h2><a class="toc-backref" href="#id32" role="doc-backlink">Provenance</a><a class="headerlink" href="#provenance" title="Link to this heading">¶</a></h2>
<p>Everything stored in the internal Roman SNPIT database has a <em>Provenance</em> associated with it.  The purpose of Provenance is twofold:</p>
<blockquote>
<div><ul class="simple">
<li><p>It allows us to store multiple versions of the same thing in the database.  (E.g., suppose you wanted to build a lightcurve for an object using two different configurations of your photometry software.  If the database just stored “the lightcurve for this object”, it wouldn’t be possible to store both.  However, in this case, the two lightcurves would have different provenances, so both can be stored.)</p></li>
<li><p>It keeps track of the code and the configuration used to create the thing stored in the database.  Ideally, this includes all of the parameters (see below) for the code, in addition to the code and code version, as well as (optionally) information about the environment in which the code should be run, such that we could reproduce the output files by running the same code with the same configuration again.</p></li>
</ul>
</div></blockquote>
<p>A provenance is defined by:</p>
<blockquote>
<div><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">process</span></code> : this is usually the name of the code that produced the thing saved to the database.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">major</span></code> and <code class="docutils literal notranslate"><span class="pre">minor</span></code> version of the process; Roman SNPIT code should use <a class="reference external" href="https://semver.org">semantic versioning</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params</span></code>, The parameters of the process (see below)</p></li>
<li><p>Optionally: the <code class="docutils literal notranslate"><span class="pre">environment</span></code>, and <code class="docutils literal notranslate"><span class="pre">env_major</span></code> and <code class="docutils literal notranslate"><span class="pre">env_minor</span></code>, the major and minor versions of the environment.  (By default, these three are all None.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">upstreams</span></code>, the immediate upstream provenances (see below).</p></li>
</ul>
</div></blockquote>
<p>An id is generated from the provenance based on a hash of all the information in the provenance, available in the <code class="docutils literal notranslate"><span class="pre">id</span></code> property of a Provenance object.  This id is a <code class="docutils literal notranslate"><span class="pre">UUID</span></code> (sort of), and will be something ugly like <code class="docutils literal notranslate"><span class="pre">f76f39a2-edcf-4e31-ba6b-e3d4335cc972</span></code>.  Crucially, every time you create a provenance with all the same information, you will always get exactly the same id.</p>
<section id="provenance-tags">
<span id="id5"></span><h3><a class="toc-backref" href="#id33" role="doc-backlink">Provenance Tags</a><a class="headerlink" href="#provenance-tags" title="Link to this heading">¶</a></h3>
<p>Provenances hold all the necessary information, and as such are cumbersome.  Provenance IDs are 128-bit numbers, and are not very human readable.  For this reason, we have <em>provenance tags</em>, which are human readable, and also allow us to collect together the provenances of a bunch of different processes into a coherent set of data products.</p>
<p>A provenance tag is defined by a human-readable string <code class="docutils literal notranslate"><span class="pre">tag</span></code>, and by the <code class="docutils literal notranslate"><span class="pre">process</span></code> (which is the same as the <code class="docutils literal notranslate"><span class="pre">process</span></code> of a Provenance.)  For a given (<code class="docutils literal notranslate"><span class="pre">tag</span></code>, <code class="docutils literal notranslate"><span class="pre">process</span></code>) pair, there can only be one Provenance.  That means that you can uniquely define a Provenance by its tag and its process.</p>
<p>We should be careful not to create tags willy-nilly.  Ideally, we will have a small number of provenance tags in the database that correspond to sets of runs through the entire pipeline.</p>
</section>
<section id="getting-provenances-from-the-database">
<h3><a class="toc-backref" href="#id34" role="doc-backlink">Getting Provenances from the Database</a><a class="headerlink" href="#getting-provenances-from-the-database" title="Link to this heading">¶</a></h3>
<p>If, somehow, you got your hands on a <code class="docutils literal notranslate"><span class="pre">provenance_id</span></code> (the ugly 128-bit number), and you want to get the full <code class="docutils literal notranslate"><span class="pre">Provenance</span></code> object for it, you can accomplish that with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.provenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">Provenance</span>

<span class="n">prov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span> <span class="n">provenance_id</span> <span class="p">)</span>
</pre></div>
</div>
<p>You will find provenance ids in the <code class="docutils literal notranslate"><span class="pre">provenance_id</span></code> field of things you pulled out of the database.  For example, if you have a <code class="docutils literal notranslate"><span class="pre">DiaObject</span></code> object (call it <code class="docutils literal notranslate"><span class="pre">obj</span></code>) that you got with <code class="docutils literal notranslate"><span class="pre">DiaObject.get_object</span></code> or <code class="docutils literal notranslate"><span class="pre">DiaObject.find_objects</span></code>, then you can find the id of the provenance of that DiaObject in <code class="docutils literal notranslate"><span class="pre">obj.provenance_id</span></code>.</p>
<p>If, instead, you know (e.g. because the user passed this on the command line) that you want to work on the objects that we have chosen to tag with the provenance tag <code class="docutils literal notranslate"><span class="pre">realtime</span></code>, and the process <code class="docutils literal notranslate"><span class="pre">rapid_alerts</span></code> (for instance, these may be objects we learned about from the RAPID alert stream), then you could get the provenance with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="o">.</span><span class="n">get_provs_for_tag</span><span class="p">(</span> <span class="s1">&#39;realtime&#39;</span><span class="p">,</span> <span class="s1">&#39;rapid_alerts&#39;</span> <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="parameters">
<span id="provenance-parameters"></span><h3><a class="toc-backref" href="#id35" role="doc-backlink">Parameters</a><a class="headerlink" href="#parameters" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">params</span></code> field of a Provenance is a dictionary that should include everything necessary for the specified version of your code to produce the same output on the same input.  It should <em>not</em> include things like input filenames.  The idea is that the <em>same</em> Provenance will apply to everything that is part of a given run.  Only when you are changing the configuration, or when you are getting input files from an earlier part of the pipeline, should the Provenance change.</p>
<p>If you are using the <a class="reference internal" href="#config"><span class="std std-ref">Config</span></a> system, and you’ve put all of these parameters (but no system-specific, like base paths, and no input files) in the config <code class="docutils literal notranslate"><span class="pre">yaml</span></code> file, then you can get a suitable <code class="docutils literal notranslate"><span class="pre">params</span></code> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dump_to_dict_for_params</span><span class="p">(</span> <span class="n">keepkeys</span><span class="o">=</span><span class="p">[</span> <span class="s1">&#39;photometry.phrosty&#39;</span> <span class="p">],</span> <span class="n">omitkeys</span><span class="o">=</span><span class="kc">None</span> <span class="p">)</span>
</pre></div>
</div>
<p>The list in <code class="docutils literal notranslate"><span class="pre">keepkeys</span></code> are the keys (including the full substructure below that key) from the config that you want to include in the dictionary.  This allows you to select out the parts of the config that are relevant to your code.  <code class="docutils literal notranslate"><span class="pre">system</span></code> and anything starting with <code class="docutils literal notranslate"><span class="pre">system.</span></code> should never be in <code class="docutils literal notranslate"><span class="pre">keepkeys</span></code>.</p>
</section>
<section id="upstreams">
<span id="provenance-upstreams"></span><h3><a class="toc-backref" href="#id36" role="doc-backlink">Upstreams</a><a class="headerlink" href="#upstreams" title="Link to this heading">¶</a></h3>
<p>The upstream provenances are the ones that created the input files you use.  For example, campari has three basic types of inputs: a <em>diaobject</em>, the supernova it’s running on; a <em>diaobject_position</em>, an updated position of the object; and <em>images</em>, the images it’s fitting its model to.  Thus, it would have three upstream provenances, one for each of these things.</p>
<p>It can figure out these upstreams by just looking at the <code class="docutils literal notranslate"><span class="pre">provenance_id</span></code> field of the objects its using.  Again, for example, campari will have (somehow) obtained a <code class="docutils literal notranslate"><span class="pre">snappl.diaobject.DiaObject</span></code> object; call that <code class="docutils literal notranslate"><span class="pre">diaobj</span></code>.  It can get the diaobject provenance by just looking at <code class="docutils literal notranslate"><span class="pre">diaobj.provenance_id</span></code>.  (To actually get the full Provenance object from the id, run <code class="docutils literal notranslate"><span class="pre">snappl.provenance.Provenance.get_by_id(</span> <span class="pre">provenance_id</span> <span class="pre">)</span></code>.)</p>
<p>Upstreams is part of the provenance because even if you run your code with all the same parameters, if you’re taking input files that were from a differently configured process earlier in the pipeline, you expect different outputs.  Upstreams basically specify which sorts of input files are valid for this provenance.</p>
</section>
<section id="creating-a-provenance">
<h3><a class="toc-backref" href="#id37" role="doc-backlink">Creating a Provenance</a><a class="headerlink" href="#creating-a-provenance" title="Link to this heading">¶</a></h3>
<p>Just create a provenance with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">snappl.provenance</span><span class="w"> </span><span class="kn">import</span> <span class="n">Provenance</span>

<span class="n">prov</span> <span class="o">=</span> <span class="n">Provenance</span><span class="p">(</span> <span class="n">process</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">params</span><span class="o">=&lt;</span><span class="n">params</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">upstreams</span><span class="o">=&lt;</span><span class="n">upstreams</span><span class="o">&gt;</span> <span class="p">)</span>
</pre></div>
</div>
<p>In this call, <code class="docutils literal notranslate"><span class="pre">process</span></code> is a string, <code class="docutils literal notranslate"><span class="pre">major</span></code> and <code class="docutils literal notranslate"><span class="pre">minor</span></code> are integers, <code class="docutils literal notranslate"><span class="pre">params</span></code> is a dictionary (see <a class="reference internal" href="#provenance-parameters"><span class="std std-ref">Parameters</span></a>), and <code class="docutils literal notranslate"><span class="pre">upstreams</span></code> is a list of <code class="docutils literal notranslate"><span class="pre">Provenance</span></code> objects (see <a class="reference internal" href="#provenance-upstreams"><span class="std std-ref">Upstreams</span></a>).</p>
<p>If this is a totally new Provenance— you’ve never made it before— then save it to the database with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prov</span><span class="o">.</span><span class="n">save_to_db</span><span class="p">(</span> <span class="n">tag</span><span class="o">=&lt;</span><span class="n">tag</span><span class="o">&gt;</span> <span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">&lt;tag&gt;</span></code> is the <a class="reference internal" href="#provenance-tags"><span class="std std-ref">provenance tag</span></a> that you want to tag this provenance with.  If the provenance already exists in the database, or if another provenance from the same process is already tagged with this tag, you will get an error.  If the provenance you’re trying to save already exists, that’s fine; it won’t resave it, it will just notice that it’s there.  So, this is safe to call even if you aren’t sure if you’ve saved it before or not.  If, for some reason, you really want this to be a new provenance, add <code class="docutils literal notranslate"><span class="pre">exists=False</span></code> to the call.  In that case, if the provenance already exists, an exception will be raised.</p>
</section>
</section>
<section id="the-roman-snpit-test-environment">
<span id="test-env"></span><h2><a class="toc-backref" href="#id38" role="doc-backlink">The Roman SNPIT Test Environment</a><a class="headerlink" href="#the-roman-snpit-test-environment" title="Link to this heading">¶</a></h2>
<p>(This is currently a bit of a mess, and I haven’t figured out how to get this to work on Perlmutter.  However, if you’re on a desktop or laptop with an <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> architecture, then you should be able to get this running on your machine using Docker.  Read all the comments at the top of <a class="reference external" href="https://github.com/Roman-Supernova-PIT/environment/blob/main/test-docker-environment/docker-compose.yaml">this file in the environment repo</a>.)</p>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="installation.html" title="Previous document">Installation</a>
        </li>
        <li>
          <a href="changes.html" title="Next document">Change Log</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2025, Roman Supernova PIT.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/usage.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>